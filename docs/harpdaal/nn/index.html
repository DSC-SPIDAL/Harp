<!DOCTYPE html><html lang="en-us"><head><link rel="shortcut icon" type="image/png" sizes="16x16" href="https://dsc-spidal.github.io/harp/img/favicon-16x9.png"><link rel="shortcut icon" type="image/png" sizes="32x32" href="https://dsc-spidal.github.io/harp/img/favicon-32x18.png"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Hugo 0.18.1" /><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="harp"><meta property="og:image" content="/img/logo54x54.png"><meta property="og:url" content="https://dsc-spidal.github.io/harp/"><meta name="twitter:title" content="harp"><meta name="twitter:image" content="/img/0-1-1.png"><meta property="og:site_name" content="Harp-DAAL-NN"><meta property="og:url" content="/docs/harpdaal/nn/"><meta property="og:description" content=""><meta name="twitter:description" content=""><title>harp Documentation - Harp-DAAL-NN</title><link rel="stylesheet" href="https://dsc-spidal.github.io/harp/css/style.min.css"><link rel="stylesheet" href="https://dsc-spidal.github.io/harp/css/font-awesome.min.css"><link rel="stylesheet" href="https://dsc-spidal.github.io/harp/css/pygments.css"></head><body><nav class="hn-top-navbar navbar navbar-inverse navbar-fixed-top" role="navigation"><div class="hn-navbar-container container-fluid"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#hn-navbar" aria-controls="hn-navbar" aria-expanded="false"><span class="sr-only"><Toggle>navigation</Toggle></span><i class="hn-toggle-button fa fa-bars"></i></button><a class="hn-navbar-logo navbar-brand" href="https://dsc-spidal.github.io/harp/"><img class="pull-left" src="https://dsc-spidal.github.io/harp/img/0-1-2.png" width="76%"></a></div><div id="hn-navbar" class="navbar-collapse collapse"><ul class="nav navbar-nav navbar-right"><li><a href="https://dsc-spidal.github.io/harp/docs/getting-started">Docs</a></li><li><a href="https://dsc-spidal.github.io/harp/api">API</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/resources">Resources</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/contributors/community">Community</a></li><li><a href="https://github.com/DSC-SPIDAL/harp/">GitHub</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/survey">Feedback</a></li><li><a href="https://groups.google.com/forum/#!forum/harp-users">Mailing List</a></li></ul></div></div></nav><div class="hn-main"><div class="container"><div class="row"><aside class="hn-sidebar hidden-xs col-sm-4 col-md-3 col-lg-2 collapse"><nav class="hn-sidebar-nav"><div id="hn-accordion" class="panel-group" role="tablist" aria-multiselectable="true"><div class="panel panel-default"><section id="quick-start" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-quick-start" aria-labelledby="quick-start"><i class="fa fa-caret-right"></i>Quick Start</a></h4></section><div id="collapse-quick-start" class="panel-collapse collapse" aria-labelledby="quick-start"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/getting-started">Harp Installation (single)</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/getting-started-cluster">Harp Installation (cluster)</a></li></ul></div></div></div><div class="panel panel-default"><section id="programming-guides" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-programming-guides" aria-labelledby="programming-guides"><i class="fa fa-caret-right"></i>Programming Guides</a></h4></section><div id="collapse-programming-guides" class="panel-collapse collapse" aria-labelledby="programming-guides"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/programming/overview">Overview</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/programming/data-interface">Data Interfaces and Types</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/programming/scheduler">Schedulers</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/programming/computation-models">Computation Models</a></li></ul></div></div></div><div class="panel panel-default"><section id="collective-communication" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-collective-communication" aria-labelledby="collective-communication"><i class="fa fa-caret-right"></i>Collective Communication</a></h4></section><div id="collapse-collective-communication" class="panel-collapse collapse" aria-labelledby="collective-communication"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/communications/broadcast">broadcast</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/reduce">reduce</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/allgather">allgather</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/allreduce">allreduce</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/regroup">regroup</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/pushandpull">push &amp; pull</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/rotate">rotate</a></li></ul></div></div></div><div class="panel panel-default"><section id="examples" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-examples" aria-labelledby="examples"><i class="fa fa-caret-right"></i>Examples</a></h4></section><div id="collapse-examples" class="panel-collapse collapse" aria-labelledby="examples"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/examples/overview">Overview</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/kmeans">K-Means</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/mlrsgd">Multiclass Logistic Regression</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/lda">Latent Dirichlet Allocation (CVB)</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/svm">Support Vector Machine</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/rf">Random Forests</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/nn">Neural Network</a></li></ul></div></div></div><div class="panel panel-default"><section id="applications" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-applications" aria-labelledby="applications"><i class="fa fa-caret-right"></i>Applications</a></h4></section><div id="collapse-applications" class="panel-collapse collapse" aria-labelledby="applications"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/applications/lda-cgs">Latent Dirichlet Allocation (CGS)</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/applications/mf">Matrix Factorization</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/applications/sahad">Sub-graph Counting</a></li></ul></div></div></div><div class="panel panel-default"><section id="harp-daal" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-harp-daal" aria-labelledby="harp-daal"><i class="fa fa-caret-right"></i>Harp-DAAL</a></h4></section><div id="collapse-harp-daal" class="panel-collapse collapse" aria-labelledby="harp-daal"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/harpdaal">Overview</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/kmeans">K-means</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/mfsgd">Matrix Factorization (SGD)</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/als">Recommender System (ALS)</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/svd">Singular Value Decomposition (SVD)</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/pca">Principal Component Analysis (PCA)</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/nn">Neural Network</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/qr">QR Decomposition (QR)</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/covariance">Covariance</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/moments">Low Order Moments</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/naive_bayes">Naive Bayes</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/linear_regression">Linear Regression</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/ridge_regression">Ridge Regression</a></li></ul></div></div></div><div class="panel panel-default"><section id="harp-resources" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-harp-resources" aria-labelledby="harp-resources"><i class="fa fa-caret-right"></i>Harp Resources</a></h4></section><div id="collapse-harp-resources" class="panel-collapse collapse" aria-labelledby="harp-resources"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/resources">Harp Resources</a></li></ul></div></div></div><div class="panel panel-default"><section id="contributors" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-contributors" aria-labelledby="contributors"><i class="fa fa-caret-right"></i>Contributors</a></h4></section><div id="collapse-contributors" class="panel-collapse collapse" aria-labelledby="contributors"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/contributors/community">Community</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/contributors/contributors">Contributors</a></li></ul></div></div></div><div class="panel panel-default"><section id="user-feedback" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-user-feedback" aria-labelledby="user-feedback"><i class="fa fa-caret-right"></i>User Feedback</a></h4></section><div id="collapse-user-feedback" class="panel-collapse collapse" aria-labelledby="user-feedback"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/survey">Online Survey</a></li></ul></div></div></div></div></nav></aside><section class="hn-docs-main col-sm-8 col-md-9 col-lg-10 col-sm-offset-4 col-md-offset-3 col-lg-offset-2"><header class="hn-docs-header page-header"><h1>Harp-DAAL-NN</h1><div class="hn-docs-description"></div></header><article class="hn-docs-content">

<p><img src="https://dsc-spidal.github.io/harp/img/nn.png" width="60%"  ></p>

<h2 id="overview">Overview</h2>

<p>Neural Networks are a beautiful biologically-inspired programming paradigm which enable a computer to learn from observational data.
The motivation for the development of neural network technology stemmed from the desire to develop an artificial system that could perform &ldquo;intelligent&rdquo; tasks similar to those performed by the human brain.
Neural networks, with their remarkable ability to derive meaning from complicated or imprecise data, can be used to extract patterns and detect trends that are too complex to be noticed by either humans or other computer techniques.</p>

<h2 id="implementation-of-harp-daal-nn">Implementation of Harp-DAAL-NN</h2>

<p>Harp-DAAL-NN is built upon the original DAAL distributed implementation of the algorithm using the Harp interface libraries for the collective communication among the data nodes. The two-step implementation is similar to the Map-Reduce Model of Hadoop.
Here are the steps to implement and run the Neural Network code.</p>

<h3 id="brief-background">Brief background</h3>

<ul>
<li><p>There are primarily three kinds of nodes involved with the implementation.</p>

<ol>
<li>name node</li>
<li>data node (divided into master and slave nodes, where slave nodes compute in parallel and communicate results to the master node)</li>
<li>login node
<br /></li>
</ol></li>

<li><p>The data files (csv <a href="http://https://github.com/01org/daal/tree/daal_2018_beta_update1/examples/data/distributed">sample</a>) which is data tagged with <code>neural_network_train</code> can be tested the following ways:</p>

<ol>
<li>On the shared location</li>
<li>On each datanode individually</li>
<li>Hadoop Filesystem Format (HDFS) <a href="https://www.tutorialspoint.com/hadoop/hadoop_hdfs_overview.htm" title="hdfs tutorial">Tutorial</a></li>
</ol></li>

<li><p>Note: The CSV files of training data each are of dimension 1500*21. Specifically, each contains 1500 training samples, and the vector size of each training sample is 20. Finally, the last column contains label (0/1) of each data sample.</p></li>

<li><p>The description of the intel daal&rsquo;s algorithm kernel used can be found <a href="https://software.intel.com/sites/products/documentation/doclib/daal/daal-user-and-reference-guides/daal_prog_guide/GUID-E8F6E40F-60EC-422B-8D46-492E110BB0BD.htm">here</a></p></li>

<li><p>The Java language services provided by Intel as a wrapper to their C++ code.</p></li>
</ul>

<h3 id="code-walk-through">Code Walk-Through</h3>

<p>The MapCollective function is defined <a href="https://github.com/DSC-SPIDAL/harp/blob/master/harp-project/src/main/java/org/apache/hadoop/mapred/CollectiveMapper.java">here</a>.</p>

<h4 id="step-1-on-slave-nodes">Step 1 (on slave nodes)</h4>

<p>The first step involves reading the files from the HDFS filesystem after splitting files between each mapper. Splitting is done by MultiFileInputFormat class defined <a href="https://github.com/DSC-SPIDAL/harp/blob/master/harp-daal-app/src/main/java/edu/iu/fileformat/MultiFileInputFormat.java">here</a>.
Data is converted into an array which is eventually converted into the DAAL <a href="https://software.intel.com/en-us/node/564579"><em>Numeric Table</em></a> data structure.  In this example the files have been stored on HDFS. The files have to be read in the DAAL table format as the local computations are performed by the DAAL libraries.</br></p>

<h2 id="getting-array-from-csv-file-below">Getting Array From CSV File (below)</h2>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">public</span> <span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">List</span><span style="color: #f92672">&lt;</span><span style="color: #66d9ef">double</span><span style="color: #f92672">[]&gt;</span> <span style="color: #a6e22e">loadPoints</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">String</span> <span style="color: #f8f8f2">file</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">pointsPerFile</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">cenVecSize</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">Configuration</span> <span style="color: #f8f8f2">conf</span><span style="color: #f92672">)</span> <span style="color: #66d9ef">throws</span> <span style="color: #f8f8f2">Exception</span> <span style="color: #f92672">{</span>
  <span style="color: #f8f8f2">List</span><span style="color: #f92672">&lt;</span><span style="color: #66d9ef">double</span><span style="color: #f92672">[]&gt;</span> <span style="color: #f8f8f2">points</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">LinkedList</span><span style="color: #f92672">&lt;</span><span style="color: #66d9ef">double</span><span style="color: #f92672">[]&gt;();</span>
  <span style="color: #66d9ef">double</span><span style="color: #f92672">[]</span> <span style="color: #f8f8f2">trainingData</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #66d9ef">double</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">pointsPerFile</span> <span style="color: #f92672">*</span> <span style="color: #f8f8f2">cenVecSize</span><span style="color: #f92672">];</span>
  <span style="color: #66d9ef">double</span><span style="color: #f92672">[]</span> <span style="color: #f8f8f2">labelData</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #66d9ef">double</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">pointsPerFile</span> <span style="color: #f92672">*</span> <span style="color: #ae81ff">1</span><span style="color: #f92672">];</span> 
  <span style="color: #f8f8f2">Path</span> <span style="color: #f8f8f2">pointFilePath</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">Path</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">file</span><span style="color: #f92672">);</span>
  <span style="color: #f8f8f2">FileSystem</span> <span style="color: #f8f8f2">fs</span> <span style="color: #f92672">=</span><span style="color: #f8f8f2">pointFilePath</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getFileSystem</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">conf</span><span style="color: #f92672">);</span>
  <span style="color: #f8f8f2">FSDataInputStream</span> <span style="color: #f8f8f2">in</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">fs</span><span style="color: #f92672">.</span><span style="color: #a6e22e">open</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">pointFilePath</span><span style="color: #f92672">);</span>
  <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">k</span> <span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f92672">;</span>
  <span style="color: #66d9ef">try</span><span style="color: #f92672">{</span>
    <span style="color: #66d9ef">for</span><span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">pointsPerFile</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">++){</span>
      <span style="color: #f8f8f2">String</span><span style="color: #f92672">[]</span> <span style="color: #f8f8f2">line</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">in</span><span style="color: #f92672">.</span><span style="color: #a6e22e">readLine</span><span style="color: #f92672">().</span><span style="color: #a6e22e">split</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;,&quot;</span><span style="color: #f92672">);</span>
      <span style="color: #66d9ef">for</span><span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">j</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span> <span style="color: #f8f8f2">j</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">cenVecSize</span><span style="color: #f92672">;</span> <span style="color: #f8f8f2">j</span><span style="color: #f92672">++){</span>
        <span style="color: #f8f8f2">trainingData</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">]</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Double</span><span style="color: #f92672">.</span><span style="color: #a6e22e">parseDouble</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">line</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">j</span><span style="color: #f92672">]);</span>
        <span style="color: #f8f8f2">k</span><span style="color: #f92672">++;</span>
      <span style="color: #f92672">}</span>
      <span style="color: #f8f8f2">labelData</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">]</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Double</span><span style="color: #f92672">.</span><span style="color: #a6e22e">parseDouble</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">line</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">cenVecSize</span><span style="color: #f92672">]);</span>
    <span style="color: #f92672">}</span>
  <span style="color: #f92672">}</span> <span style="color: #66d9ef">finally</span> <span style="color: #f92672">{</span>
    <span style="color: #f8f8f2">in</span><span style="color: #f92672">.</span><span style="color: #a6e22e">close</span><span style="color: #f92672">();</span>
    <span style="color: #f8f8f2">points</span><span style="color: #f92672">.</span><span style="color: #a6e22e">add</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">trainingData</span><span style="color: #f92672">);</span>
    <span style="color: #f8f8f2">points</span><span style="color: #f92672">.</span><span style="color: #a6e22e">add</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">labelData</span><span style="color: #f92672">);</span>
  <span style="color: #f92672">}</span>
  <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">points</span><span style="color: #f92672">;</span>
<span style="color: #f92672">}</span> 
</pre></div>

<h2 id="converting-array-to-numeric-table-below">Converting Array to Numeric Table (below)</h2>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">//initializing Numeric Table</span>
<span style="color: #f8f8f2">NumericTable</span> <span style="color: #f8f8f2">featureArray_daal</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">HomogenNumericTable</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">daal_Context</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">Double</span><span style="color: #f92672">.</span><span style="color: #a6e22e">class</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">nFeature</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">featuretableSize</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">NumericTable</span><span style="color: #f92672">.</span><span style="color: #a6e22e">AllocationFlag</span><span style="color: #f92672">.</span><span style="color: #a6e22e">DoAllocate</span><span style="color: #f92672">);</span>
<span style="color: #f8f8f2">NumericTable</span> <span style="color: #f8f8f2">labelArray_daal</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">HomogenNumericTable</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">daal_Context</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">Double</span><span style="color: #f92672">.</span><span style="color: #a6e22e">class</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">nLabel</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">labeltableSize</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">NumericTable</span><span style="color: #f92672">.</span><span style="color: #a6e22e">AllocationFlag</span><span style="color: #f92672">.</span><span style="color: #a6e22e">DoAllocate</span><span style="color: #f92672">);</span>

<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">row_idx_feature</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">row_len_feature</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span>

<span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f92672">;</span> <span style="color: #f8f8f2">k</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">featurePoints</span><span style="color: #f92672">.</span><span style="color: #a6e22e">size</span><span style="color: #f92672">();</span> <span style="color: #f8f8f2">k</span><span style="color: #f92672">++)</span> <span style="color: #f92672">{</span>
  <span style="color: #f8f8f2">row_len_feature</span> <span style="color: #f92672">=(</span><span style="color: #f8f8f2">array_data_feature</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">].</span><span style="color: #a6e22e">length</span><span style="color: #f92672">)/(</span><span style="color: #66d9ef">int</span><span style="color: #f92672">)</span><span style="color: #f8f8f2">nFeature</span><span style="color: #f92672">;</span>
  <span style="color: #75715e">//release data from Java side to native side</span>
  <span style="color: #f92672">((</span><span style="color: #f8f8f2">HomogenNumericTable</span><span style="color: #f92672">)</span><span style="color: #f8f8f2">featureArray_daal</span><span style="color: #f92672">).</span><span style="color: #a6e22e">releaseBlockOfRows</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">row_idx_feature</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">row_len_feature</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">Doub</span>  <span style="color: #f8f8f2">leBuffer</span><span style="color: #f92672">.</span><span style="color: #a6e22e">wrap</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">array_data_feature</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">]));</span>
  <span style="color: #f8f8f2">row_idx_feature</span> <span style="color: #f92672">+=</span> <span style="color: #f8f8f2">row_len_feature</span><span style="color: #f92672">;</span>
<span style="color: #f92672">}</span>

<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">row_idx_label</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span>
<span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">row_len_label</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span>
    
<span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">k</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f92672">;</span> <span style="color: #f8f8f2">k</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">labelPoints</span><span style="color: #f92672">.</span><span style="color: #a6e22e">size</span><span style="color: #f92672">();</span> <span style="color: #f8f8f2">k</span><span style="color: #f92672">++)</span> 
<span style="color: #f92672">{</span>
  <span style="color: #f8f8f2">row_len_label</span> <span style="color: #f92672">=</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">array_data_label</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">].</span><span style="color: #a6e22e">length</span><span style="color: #f92672">)/(</span><span style="color: #66d9ef">int</span><span style="color: #f92672">)</span><span style="color: #f8f8f2">nLabel</span><span style="color: #f92672">;</span>
  <span style="color: #75715e">//release data from Java side to native side</span>
  <span style="color: #f92672">((</span><span style="color: #f8f8f2">HomogenNumericTable</span><span style="color: #f92672">)</span><span style="color: #f8f8f2">labelArray_daal</span><span style="color: #f92672">).</span><span style="color: #a6e22e">releaseBlockOfRows</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">row_idx_label</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">row_len_label</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">DoubleBuffer</span><span style="color: #f92672">.</span><span style="color: #a6e22e">wrap</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">array_data_label</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">]));</span>
  <span style="color: #f8f8f2">row_idx_label</span> <span style="color: #f92672">+=</span> <span style="color: #f8f8f2">row_len_label</span><span style="color: #f92672">;</span>
<span style="color: #f92672">}</span>
</pre></div>

<h4 id="step-2-on-slave-node">Step 2 (on slave node)</h4>

<p>Basic input parameters such as optimization solver(sgd) training model are obtained for the initialization of the algorithm on local nodes. The Neural Network algorithm is created and its input is set as the Numeric Table created in the previous step.</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">double</span><span style="color: #f92672">[]</span> <span style="color: #f8f8f2">learningRateArray</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #66d9ef">double</span><span style="color: #f92672">[</span><span style="color: #ae81ff">1</span><span style="color: #f92672">];</span>
<span style="color: #f8f8f2">learningRateArray</span><span style="color: #f92672">[</span><span style="color: #ae81ff">0</span><span style="color: #f92672">]</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0.001</span><span style="color: #f92672">;</span>
<span style="color: #f8f8f2">com</span><span style="color: #f92672">.</span><span style="color: #a6e22e">intel</span><span style="color: #f92672">.</span><span style="color: #a6e22e">daal</span><span style="color: #f92672">.</span><span style="color: #a6e22e">algorithms</span><span style="color: #f92672">.</span><span style="color: #a6e22e">optimization_solver</span><span style="color: #f92672">.</span><span style="color: #a6e22e">sgd</span><span style="color: #f92672">.</span><span style="color: #a6e22e">Batch</span> <span style="color: #f8f8f2">sgdAlgorithm</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">com</span><span style="color: #f92672">.</span><span style="color: #a6e22e">intel</span><span style="color: #f92672">.</span><span style="color: #a6e22e">daal</span><span style="color: #f92672">.</span><span style="color: #a6e22e">algorithms</span><span style="color: #f92672">.</span><span style="color: #a6e22e">optimization_solver</span><span style="color: #f92672">.</span><span style="color: #a6e22e">sgd</span><span style="color: #f92672">.</span><span style="color: #a6e22e">Batch</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">daal_Context</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">Double</span><span style="color: #f92672">.</span><span style="color: #a6e22e">class</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">com</span><span style="color: #f92672">.</span><span style="color: #a6e22e">intel</span><span style="color: #f92672">.</span><span style="color: #a6e22e">daal</span><span style="color: #f92672">.</span><span style="color: #a6e22e">algorithms</span><span style="color: #f92672">.</span><span style="color: #a6e22e">optimization_solver</span><span style="color: #f92672">.</span><span style="color: #a6e22e">sgd</span><span style="color: #f92672">.</span><span style="color: #a6e22e">Method</span><span style="color: #f92672">.</span><span style="color: #a6e22e">defaultDense</span><span style="color: #f92672">);</span>
<span style="color: #f8f8f2">sgdAlgorithm</span><span style="color: #f92672">.</span><span style="color: #a6e22e">parameter</span><span style="color: #f92672">.</span><span style="color: #a6e22e">setBatchSize</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">batchSizeLocal</span><span style="color: #f92672">);</span>
<span style="color: #f8f8f2">sgdAlgorithm</span><span style="color: #f92672">.</span><span style="color: #a6e22e">parameter</span><span style="color: #f92672">.</span><span style="color: #a6e22e">setLearningRateSequence</span><span style="color: #f92672">(</span><span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">HomogenNumericTable</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">daal_Context</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">learningRateArray</span><span style="color: #f92672">,</span> <span style="color: #ae81ff">1</span><span style="color: #f92672">,</span> <span style="color: #ae81ff">1</span><span style="color: #f92672">));</span>

<span style="color: #f8f8f2">net</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">DistributedStep2Master</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">daal_Context</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">sgdAlgorithm</span><span style="color: #f92672">);</span>
<span style="color: #f8f8f2">TrainingTopology</span> <span style="color: #f8f8f2">topology</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">NeuralNetConfiguratorDistr</span><span style="color: #f92672">.</span><span style="color: #a6e22e">configureNet</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">daal_Context</span><span style="color: #f92672">);</span>

<span style="color: #f8f8f2">net</span><span style="color: #f92672">.</span><span style="color: #a6e22e">parameter</span><span style="color: #f92672">.</span><span style="color: #a6e22e">setOptimizationSolver</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">sgdAlgorithm</span><span style="color: #f92672">);</span>
<span style="color: #f8f8f2">net</span><span style="color: #f92672">.</span><span style="color: #a6e22e">initialize</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">featureTensorInit</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getDimensions</span><span style="color: #f92672">(),</span> <span style="color: #f8f8f2">topology</span><span style="color: #f92672">);</span>

<span style="color: #f8f8f2">TrainingModel</span> <span style="color: #f8f8f2">trainingModel</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">net</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getResult</span><span style="color: #f92672">().</span><span style="color: #a6e22e">get</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">TrainingResultId</span><span style="color: #f92672">.</span><span style="color: #a6e22e">model</span><span style="color: #f92672">);</span>
</pre></div>

<p>Computation is done iteratively for each batch, and the input data is obtained from Numeric Table using the Service class function.</p>

<h2 id="results-are-computed-on-slave-nodes-as-below">Results are computed on slave nodes (as below)</h2>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">DistributedStep1Local</span> <span style="color: #f8f8f2">netLocal</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">DistributedStep1Local</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">daal_Context</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">sgdAlgorithm</span><span style="color: #f92672">);</span>
<span style="color: #f8f8f2">netLocal</span><span style="color: #f92672">.</span><span style="color: #a6e22e">input</span><span style="color: #f92672">.</span><span style="color: #a6e22e">set</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">DistributedStep1LocalInputId</span><span style="color: #f92672">.</span><span style="color: #a6e22e">inputModel</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">trainingModel</span><span style="color: #f92672">);</span>
<span style="color: #f8f8f2">netLocal</span><span style="color: #f92672">.</span><span style="color: #a6e22e">input</span><span style="color: #f92672">.</span><span style="color: #a6e22e">set</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">TrainingInputId</span><span style="color: #f92672">.</span><span style="color: #a6e22e">data</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">Service</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getNextSubtensor</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">daal_Context</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">featureTensorInit</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">batchSizeLocal</span><span style="color: #f92672">));</span>
<span style="color: #f8f8f2">netLocal</span><span style="color: #f92672">.</span><span style="color: #a6e22e">input</span><span style="color: #f92672">.</span><span style="color: #a6e22e">set</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">TrainingInputId</span><span style="color: #f92672">.</span><span style="color: #a6e22e">groundTruth</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">Service</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getNextSubtensor</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">daal_Context</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">labelTensorInit</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">batchSizeLocal</span><span style="color: #f92672">));</span>
<span style="color: #f8f8f2">netLocal</span><span style="color: #f92672">.</span><span style="color: #a6e22e">parameter</span><span style="color: #f92672">.</span><span style="color: #a6e22e">setOptimizationSolver</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">sgdAlgorithm</span><span style="color: #f92672">);</span>
<span style="color: #f8f8f2">PartialResult</span> <span style="color: #f8f8f2">partialResult</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">netLocal</span><span style="color: #f92672">.</span><span style="color: #a6e22e">compute</span><span style="color: #f92672">();</span>   
</pre></div>

<h4 id="step-3-communication">Step 3 (communication)</h4>

<p>The partial results are sent to the master node for final computations using <a href="https://dsc-spidal.github.io/harp/docs/communications/reduce/" title="harp reduce">reduce</a>.</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">/*Do an reduce to send all the data to the master node*/</span>
<span style="color: #f8f8f2">Table</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">ByteArray</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">partialResultTable</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">this</span><span style="color: #f92672">.</span><span style="color: #a6e22e">reduce</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;nn&quot;</span><span style="color: #f92672">,</span> <span style="color: #e6db74">&quot;sync-partialresult&quot;</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">partialResultTable</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">this</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getMasterID</span><span style="color: #f92672">());</span>
</pre></div>

<h4 id="step-4-on-master-node">Step 4 (on master node)</h4>

<p>The master node obtains the final result aggregated from the slave nodes (below)</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">//adding partial result in master algorithm</span>
<span style="color: #66d9ef">for</span><span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">j</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span> <span style="color: #f8f8f2">j</span><span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">pid</span><span style="color: #f92672">.</span><span style="color: #a6e22e">length</span><span style="color: #f92672">;</span> <span style="color: #f8f8f2">j</span><span style="color: #f92672">++){</span>
  <span style="color: #f8f8f2">net</span><span style="color: #f92672">.</span><span style="color: #a6e22e">input</span><span style="color: #f92672">.</span><span style="color: #a6e22e">add</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">DistributedStep2MasterInputId</span><span style="color: #f92672">.</span><span style="color: #a6e22e">partialResults</span><span style="color: #f92672">,</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">deserializePartialResult</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">partialResultTable</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getPartition</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">pid</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">j</span><span style="color: #f92672">]).</span><span style="color: #a6e22e">get</span><span style="color: #f92672">()));</span>
<span style="color: #f92672">}</span>
<span style="color: #f8f8f2">DistributedPartialResult</span> <span style="color: #f8f8f2">result</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">net</span><span style="color: #f92672">.</span><span style="color: #a6e22e">compute</span><span style="color: #f92672">();</span>
<span style="color: #f8f8f2">wbHarpTable</span><span style="color: #f92672">.</span><span style="color: #a6e22e">addPartition</span><span style="color: #f92672">(</span><span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">Partition</span><span style="color: #f92672">&lt;(</span><span style="color: #66d9ef">this</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getMasterID</span><span style="color: #f92672">(),</span>  <span style="color: #f8f8f2">serializeNumericTable</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">result</span><span style="color: #f92672">.</span><span style="color: #a6e22e">get</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">DistributedPartialResultId</span><span style="color: #f92672">.</span><span style="color: #a6e22e">resultFromMaster</span><span style="color: #f92672">).</span><span style="color: #a6e22e">get</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">TrainingResultId</span><span style="color: #f92672">.</span><span style="color: #a6e22e">model</span><span style="color: #f92672">).</span><span style="color: #a6e22e">getWeightsAndBiases</span><span style="color: #f92672">())));</span>
<span style="color: #f8f8f2">NumericTable</span> <span style="color: #f8f8f2">wbMaster</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">result</span><span style="color: #f92672">.</span><span style="color: #a6e22e">get</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">DistributedPartialResultId</span><span style="color: #f92672">.</span><span style="color: #a6e22e">resultFromMaster</span><span style="color: #f92672">).</span><span style="color: #a6e22e">get</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">TrainingResultId</span><span style="color: #f92672">.</span><span style="color: #a6e22e">model</span><span style="color: #f92672">).</span><span style="color: #a6e22e">getWeightsAndBiases</span><span style="color: #f92672">();</span>
</pre></div>

<h4 id="step-5-results">Step 5 (Results)</h4>

<p>TrainingResult  can be printed using the Service class function.</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">TrainingResult</span> <span style="color: #f8f8f2">result</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">net</span><span style="color: #f92672">.</span><span style="color: #a6e22e">finalizeCompute</span><span style="color: #f92672">();</span>
<span style="color: #f8f8f2">TrainingModel</span> <span style="color: #f8f8f2">finalTrainingModel</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">result</span><span style="color: #f92672">.</span><span style="color: #a6e22e">get</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">TrainingResultId</span><span style="color: #f92672">.</span><span style="color: #a6e22e">model</span><span style="color: #f92672">);</span>
<span style="color: #f8f8f2">PredictionModel</span> <span style="color: #f8f8f2">predictionModel</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">trainingModel</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getPredictionModel</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">Float</span><span style="color: #f92672">.</span><span style="color: #a6e22e">class</span><span style="color: #f92672">);</span>
<span style="color: #f8f8f2">Tensor</span> <span style="color: #f8f8f2">predictionData</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">getTensor</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">daal_Context</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">conf</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">testFilePath</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">,</span> <span style="color: #ae81ff">2000</span><span style="color: #f92672">);</span>
<span style="color: #f8f8f2">Tensor</span> <span style="color: #f8f8f2">predictionGroundTruth</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">getTensor</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">daal_Context</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">conf</span><span style="color: #f92672">,</span> <span style="color: #e6db74">&quot;/nn/test/neural_network_test_ground_truth.csv&quot;</span><span style="color: #f92672">,</span> <span style="color: #ae81ff">1</span><span style="color: #f92672">,</span> <span style="color: #ae81ff">2000</span><span style="color: #f92672">);</span>
<span style="color: #f8f8f2">PredictionBatch</span> <span style="color: #f8f8f2">net</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">PredictionBatch</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">daal_Context</span><span style="color: #f92672">);</span>
<span style="color: #66d9ef">long</span><span style="color: #f92672">[]</span> <span style="color: #f8f8f2">predictionDimensions</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">predictionData</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getDimensions</span><span style="color: #f92672">();</span>
<span style="color: #f8f8f2">net</span><span style="color: #f92672">.</span><span style="color: #a6e22e">parameter</span><span style="color: #f92672">.</span><span style="color: #a6e22e">setBatchSize</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">predictionDimensions</span><span style="color: #f92672">[</span><span style="color: #ae81ff">0</span><span style="color: #f92672">]);</span>
<span style="color: #75715e">// setting the input data from test file </span>
<span style="color: #f8f8f2">net</span><span style="color: #f92672">.</span><span style="color: #a6e22e">input</span><span style="color: #f92672">.</span><span style="color: #a6e22e">set</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">PredictionTensorInputId</span><span style="color: #f92672">.</span><span style="color: #a6e22e">data</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">predictionData</span><span style="color: #f92672">);</span>
<span style="color: #75715e">//setting the prediction model</span>
<span style="color: #f8f8f2">net</span><span style="color: #f92672">.</span><span style="color: #a6e22e">input</span><span style="color: #f92672">.</span><span style="color: #a6e22e">set</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">PredictionModelInputId</span><span style="color: #f92672">.</span><span style="color: #a6e22e">model</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">predictionModel</span><span style="color: #f92672">);</span>
<span style="color: #f8f8f2">predictionResult</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">net</span><span style="color: #f92672">.</span><span style="color: #a6e22e">compute</span><span style="color: #f92672">();</span>
<span style="color: #75715e">//printing the results</span>
<span style="color: #f8f8f2">Service</span><span style="color: #f92672">.</span><span style="color: #a6e22e">printTensors</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;Ground truth&quot;</span><span style="color: #f92672">,</span> <span style="color: #e6db74">&quot;Neural network predictions: each class probability&quot;</span><span style="color: #f92672">,</span>
<span style="color: #e6db74">&quot;Neural network classification results (first 50 observations):&quot;</span><span style="color: #f92672">,</span><span style="color: #f8f8f2">predictionGroundTruth</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">predictionResult</span><span style="color: #f92672">.</span><span style="color: #a6e22e">get</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">PredictionResultId</span><span style="color: #f92672">.</span><span style="color: #a6e22e">prediction</span><span style="color: #f92672">),</span> <span style="color: #ae81ff">50</span><span style="color: #f92672">);</span>
</pre></div>

<h3 id="executing-the-code">Executing the code</h3>

<h4 id="setting-up-hadoop-and-harp-daal">Setting up Hadoop and Harp-daal</h4>

<hr />

<p>Details about setting up Hadoop along with Harp-DAAL on the cluster can be found <a href="https://dsc-spidal.github.io/harp/docs/getting-started-cluster/" title="Harp Cluster Installation">here</a> and <a href="https://dsc-spidal.github.io/harp/docs/harpdaal/harpdaal/" title="DAAL Installation">here</a>.</p>

<h4 id="running-the-code">Running the code</h4>

<hr />

<p>Make sure that the code is placed in the <code>/harp/harp-daal-app</code> directory.
Run the <code>harp-daal-nn-run.sh</code> script here to run the code.</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">cd</span> <span style="color: #f8f8f2">$HARP_ROOT</span>/harp-daal-app
./harp-daal-nn.sh  
</pre></div>

<p>Details of the script can be seen below:</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">#!/bin/bash</span>

<span style="color: #75715e"># enter the directory of hadoop and copy your_harp_daal.jar file here</span>
cp ./target/harp-daal-app-1.0-SNAPSHOT.jar <span style="color: #e6db74">${</span><span style="color: #f8f8f2">HADOOP_HOME</span><span style="color: #e6db74">}</span>
<span style="color: #75715e"># set up daal environment</span>
<span style="color: #75715e">#source ./__release_tango_lnx/daal/bin/daalvars.sh intel64</span>
<span style="color: #f8f8f2">echo</span> <span style="color: #e6db74">&quot;${</span><span style="color: #f8f8f2">DAALROOT</span><span style="color: #e6db74">}&quot;</span>

<span style="color: #f8f8f2">cd</span> <span style="color: #e6db74">${</span><span style="color: #f8f8f2">HADOOP_HOME</span><span style="color: #e6db74">}</span>

<span style="color: #75715e"># check that safemode is not enabled </span>
hdfs dfsadmin -safemode get <span style="color: #f8f8f2">|</span> grep -q <span style="color: #e6db74">&quot;ON&quot;</span>
<span style="color: #66d9ef">if</span> <span style="color: #f92672">[[</span> <span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">$?</span><span style="color: #e6db74">&quot;</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;0&quot;</span>  <span style="color: #f92672">]]</span><span style="color: #f8f8f2">;</span> <span style="color: #66d9ef">then</span>
    hdfs dfsadmin -safemode leave
<span style="color: #66d9ef">fi</span>

<span style="color: #75715e"># put daal and tbb, omp libs to hdfs, they will be loaded into the distributed cache</span>
hdfs dfs -mkdir -p /Hadoop/Libraries
hdfs dfs -rm /Hadoop/Libraries/*
hdfs dfs -put <span style="color: #e6db74">${</span><span style="color: #f8f8f2">DAALROOT</span><span style="color: #e6db74">}</span>/lib/intel64_lin/libJavaAPI.so /Hadoop/Libraries/
hdfs dfs -put <span style="color: #e6db74">${</span><span style="color: #f8f8f2">TBB_ROOT</span><span style="color: #e6db74">}</span>/lib/intel64_lin_mic/libtbb* /Hadoop/Libraries/
hdfs dfs -put /N/u/mayank/daal/omp/lib/libiomp5.so /Hadoop/Libraries/

<span style="color: #75715e"># daal.jar will be used in command line</span>
<span style="color: #f8f8f2">export</span> <span style="color: #f8f8f2">LIBJARS</span><span style="color: #f92672">=</span><span style="color: #e6db74">${</span><span style="color: #f8f8f2">DAALROOT</span><span style="color: #e6db74">}</span>/lib/daal.jar

<span style="color: #75715e"># num of training data points</span>
<span style="color: #75715e">#Pts=50000</span>
<span style="color: #75715e"># num of training data centroids</span>
<span style="color: #75715e">#Ced=1000</span>
<span style="color: #75715e"># feature vector dimension</span>
<span style="color: #75715e">#Dim=100</span>
<span style="color: #75715e"># file per mapper</span>
<span style="color: #75715e">#File=5</span>
<span style="color: #75715e"># iteration times</span>
<span style="color: #75715e">#ITR=10</span>
<span style="color: #75715e"># memory allocated to each mapper (MB)</span>
<span style="color: #75715e">#Mem=185000</span>
<span style="color: #75715e"># generate training data or not (once generated, data file /kmeans-P$Pts-C$Ced-D$Dim-N$Node is in hdfs, you could reuse them next time)</span>
<span style="color: #75715e">#GenData=false</span>
<span style="color: #75715e"># num of mappers (nodes)</span>
<span style="color: #f8f8f2">Node</span><span style="color: #f92672">=</span><span style="color: #ae81ff">2</span>
<span style="color: #75715e"># num of threads on each mapper(node)</span>
<span style="color: #f8f8f2">Thd</span><span style="color: #f92672">=</span><span style="color: #ae81ff">64</span>

hadoop jar harp-daal-app-1.0-SNAPSHOT.jar edu.iu.daal_nn.NNDaalLauncher -libjars <span style="color: #e6db74">${</span><span style="color: #f8f8f2">LIBJARS</span><span style="color: #e6db74">}</span>  /nn/input /nn/work <span style="color: #f8f8f2">$Node</span> <span style="color: #f8f8f2">$Thd</span> 
</pre></div>
</article></section></div></div></div><script src="https://code.jquery.com/jquery-2.2.1.min.js"></script><script src="https://dsc-spidal.github.io/harp/js/app.min.js"></script></body></html>