<!DOCTYPE html><html lang="en-us"><head><link rel="shortcut icon" type="image/png" sizes="16x16" href="https://dsc-spidal.github.io/harp/img/favicon-16x9.png"><link rel="shortcut icon" type="image/png" sizes="32x32" href="https://dsc-spidal.github.io/harp/img/favicon-32x18.png"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Hugo 0.18.1" /><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="harp"><meta property="og:image" content="/img/logo54x54.png"><meta property="og:url" content="https://dsc-spidal.github.io/harp/"><meta name="twitter:title" content="harp"><meta name="twitter:image" content="/img/0-1-1.png"><meta property="og:site_name" content="Harp Kmeans"><meta property="og:url" content="/docs/examples/allreducekmeans/"><meta property="og:description" content=""><meta name="twitter:description" content=""><title>harp Documentation - Harp Kmeans</title><link rel="stylesheet" href="https://dsc-spidal.github.io/harp/css/style.min.css"><link rel="stylesheet" href="https://dsc-spidal.github.io/harp/css/font-awesome.min.css"><link rel="stylesheet" href="https://dsc-spidal.github.io/harp/css/pygments.css"></head><body><nav class="hn-top-navbar navbar navbar-inverse navbar-fixed-top" role="navigation"><div class="hn-navbar-container container-fluid"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#hn-navbar" aria-controls="hn-navbar" aria-expanded="false"><span class="sr-only"><Toggle>navigation</Toggle></span><i class="hn-toggle-button fa fa-bars"></i></button><a class="hn-navbar-logo navbar-brand" href="https://dsc-spidal.github.io/harp/"><img class="pull-left" src="https://dsc-spidal.github.io/harp/img/0-1-2.png"></a></div><div id="hn-navbar" class="navbar-collapse collapse"><ul class="nav navbar-nav navbar-right"><li><a href="https://dsc-spidal.github.io/harp/docs/getting-started">Docs</a></li><li><a href="https://dsc-spidal.github.io/harp/api">API</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/resources">Resources</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/contributors/community">Community</a></li><li><a href="https://github.com/DSC-SPIDAL/harp/">GitHub</a></li><li><a href="https://groups.google.com/forum/#!forum/harp-users">Mailing List</a></li></ul></div></div></nav><div class="hn-main"><div class="container"><div class="row"><aside class="hn-sidebar hidden-xs col-sm-4 col-md-3 col-lg-2 collapse"><nav class="hn-sidebar-nav"><div id="hn-accordion" class="panel-group" role="tablist" aria-multiselectable="true"><div class="panel panel-default"><section id="quick-start" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-quick-start" aria-labelledby="quick-start"><i class="fa fa-caret-right"></i>Quick Start</a></h4></section><div id="collapse-quick-start" class="panel-collapse collapse" aria-labelledby="quick-start"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/getting-started">Harp Installation</a></li></ul></div></div></div><div class="panel panel-default"><section id="programming-guides" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-programming-guides" aria-labelledby="programming-guides"><i class="fa fa-caret-right"></i>Programming Guides</a></h4></section><div id="collapse-programming-guides" class="panel-collapse collapse" aria-labelledby="programming-guides"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/programming/data-interface">Data Interfaces and Types</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/programming/scheduler">Schedulers</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/programming/computation-models">Computation Models</a></li></ul></div></div></div><div class="panel panel-default"><section id="collective-communication" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-collective-communication" aria-labelledby="collective-communication"><i class="fa fa-caret-right"></i>Collective Communication</a></h4></section><div id="collapse-collective-communication" class="panel-collapse collapse" aria-labelledby="collective-communication"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/communications/broadcast">broadcast</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/reduce">reduce</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/allgather">allgather</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/allreduce">allreduce</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/regroup">regroup</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/pushandpull">push &amp; pull</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/rotate">rotate</a></li></ul></div></div></div><div class="panel panel-default"><section id="examples" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-examples" aria-labelledby="examples"><i class="fa fa-caret-right"></i>Examples</a></h4></section><div id="collapse-examples" class="panel-collapse collapse" aria-labelledby="examples"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/examples/kmeans">K-Means</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/mlrsgd">Multiclass Logistic Regression</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/lda">Latent Dirichlet Allocation (CVB)</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/svm">Support Vector Machine</a></li></ul></div></div></div><div class="panel panel-default"><section id="applications" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-applications" aria-labelledby="applications"><i class="fa fa-caret-right"></i>Applications</a></h4></section><div id="collapse-applications" class="panel-collapse collapse" aria-labelledby="applications"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/applications/lda-cgs">Latent Dirichlet Allocation (CGS)</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/applications/mf">Matrix Factorization</a></li></ul></div></div></div><div class="panel panel-default"><section id="harp-daal" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-harp-daal" aria-labelledby="harp-daal"><i class="fa fa-caret-right"></i>Harp-DAAL</a></h4></section><div id="collapse-harp-daal" class="panel-collapse collapse" aria-labelledby="harp-daal"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/harpdaal">Harp-DAAL</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/Example">Example</a></li></ul></div></div></div><div class="panel panel-default"><section id="harp-resources" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-harp-resources" aria-labelledby="harp-resources"><i class="fa fa-caret-right"></i>Harp Resources</a></h4></section><div id="collapse-harp-resources" class="panel-collapse collapse" aria-labelledby="harp-resources"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/resources">Harp Resources</a></li></ul></div></div></div><div class="panel panel-default"><section id="contributors" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-contributors" aria-labelledby="contributors"><i class="fa fa-caret-right"></i>Contributors</a></h4></section><div id="collapse-contributors" class="panel-collapse collapse" aria-labelledby="contributors"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/contributors/community">Community</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/contributors/contributors">Contributors</a></li></ul></div></div></div></div></nav></aside><section class="hn-docs-main col-sm-8 col-md-9 col-lg-10 col-sm-offset-4 col-md-offset-3 col-lg-offset-2"><header class="hn-docs-header page-header"><h1>Harp Kmeans</h1><div class="hn-docs-description"></div></header><article class="hn-docs-content">

<p>The K-Means algorithm simply repeats the following set of steps until there is no change in the partition:</p>

<ul>
<li>Choose <code>K</code> points as the initial set of centroids.</li>
<li>Assign each data point in the data set to the closest centroid (this is done by calculating the distance between the data point and each centroid).</li>
<li>Calculate the new centroids based on the clusters that were generated in step 2. Normally this is done by calculating the mean of each cluster.</li>
<li>Repeat steps 2 and 3 until data points do not change cluster assignments, meaning their centroids are set.</li>
</ul>

<p>Because Harp will use <code>ant</code> to compile the whole code base, we ask you to add your file path in <code>$HARP3_PROJECT_HOME/harp3-app/build.xml</code>.</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>...
<span style="color: #f92672">&lt;src</span> <span style="color: #a6e22e">path=</span><span style="color: #e6db74">&quot;src&quot;</span> <span style="color: #f92672">/&gt;</span>
    <span style="color: #f92672">&lt;include</span> <span style="color: #a6e22e">name=</span><span style="color: #e6db74">&quot;edu/iu/fileformat/**&quot;</span> <span style="color: #f92672">/&gt;</span>
    <span style="color: #f92672">&lt;include</span> <span style="color: #a6e22e">name=</span><span style="color: #e6db74">&quot;edu/iu/benchmark/**&quot;</span> <span style="color: #f92672">/&gt;</span>
    <span style="color: #f92672">&lt;include</span> <span style="color: #a6e22e">name=</span><span style="color: #e6db74">&quot;edu/iu/dymoro/**&quot;</span> <span style="color: #f92672">/&gt;</span>
    <span style="color: #f92672">&lt;include</span> <span style="color: #a6e22e">name=</span><span style="color: #e6db74">&quot;edu/iu/kmeans/**&quot;</span> <span style="color: #f92672">/&gt;</span>
    <span style="color: #f92672">&lt;include</span> <span style="color: #a6e22e">name=</span><span style="color: #e6db74">&quot;edu/iu/lda/**&quot;</span> <span style="color: #f92672">/&gt;</span>
    <span style="color: #f92672">&lt;include</span> <span style="color: #a6e22e">name=</span><span style="color: #e6db74">&quot;edu/iu/sgd/**&quot;</span> <span style="color: #f92672">/&gt;</span>
    <span style="color: #f92672">&lt;include</span> <span style="color: #a6e22e">name=</span><span style="color: #e6db74">&quot;edu/iu/ccd/**&quot;</span> <span style="color: #f92672">/&gt;</span>
    <span style="color: #f92672">&lt;include</span> <span style="color: #a6e22e">name=</span><span style="color: #e6db74">&quot;edu/iu/wdamds/**&quot;</span> <span style="color: #f92672">/&gt;</span>
    <span style="color: #f92672">&lt;include</span> <span style="color: #a6e22e">name=</span><span style="color: #e6db74">&quot;&lt;your file path&gt;&quot;</span> <span style="color: #f92672">/&gt;</span>
    ...
</pre></div>

<p>THen you can use <code>ant</code> to compile Harp and use the output <code>harp3-app-hadoop-2.6.0.jar</code> to run with Hadoop.</p>

<p>Definitions:</p>

<ul>
<li><code>N</code> is the number of data points</li>
<li><code>M</code> is the number of centroids</li>
<li><code>D</code> is the dimension of centroids</li>
<li><code>Vi</code> refers to the <code>i</code>th data point (vector)</li>
<li><code>Cj</code> refers to the <code>j</code>th centroid</li>
</ul>

<h2 id="step-1-generate-data-points">Step 1 &mdash; Generate data points</h2>

<p>The actual method is in <code>Utils.java</code>. This method generates a set of data points and writes them into the specified folder. The method also takes in parameters to specify the number of files and number of data points that need to be generated. The data points are divided among the data files. You will generate <code>numMapTasks</code> data files, with each data file containing a part of the data points. Then you can generate data to <code>localDirStr</code> and use <code>fs</code> to copy the data to <code>dataDir</code>.</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">generateData</span><span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">numOfDataPoints</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">numMapTasks</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">FileSystem</span> <span style="color: #f8f8f2">fs</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">String</span> <span style="color: #f8f8f2">localDirStr</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">Path</span> <span style="color: #f8f8f2">dataDir</span><span style="color: #f92672">)</span> <span style="color: #66d9ef">throws</span> <span style="color: #f8f8f2">IOException</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">InterruptedException</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">ExecutionException</span> <span style="color: #f92672">{</span>
    <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">pointsPerFile</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">numOfDataPoints</span> <span style="color: #f92672">/</span> <span style="color: #f8f8f2">numMapTasks</span><span style="color: #f92672">;</span>
    <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">pointsRemainder</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">numOfDataPoints</span> <span style="color: #f92672">%</span> <span style="color: #f8f8f2">numMapTasks</span><span style="color: #f92672">;</span>
    <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">.</span><span style="color: #a6e22e">exists</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">dataDir</span><span style="color: #f92672">))</span>
        <span style="color: #f8f8f2">fs</span><span style="color: #f92672">.</span><span style="color: #a6e22e">delete</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">dataDir</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">true</span><span style="color: #f92672">);</span>
    <span style="color: #f8f8f2">File</span> <span style="color: #f8f8f2">localDir</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">File</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">localDirStr</span><span style="color: #f92672">);</span>
    <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">localDir</span><span style="color: #f92672">.</span><span style="color: #a6e22e">exists</span><span style="color: #f92672">()</span> <span style="color: #f92672">&amp;&amp;</span> <span style="color: #f8f8f2">localDir</span><span style="color: #f92672">.</span><span style="color: #a6e22e">isDirectory</span><span style="color: #f92672">())</span> <span style="color: #f92672">{</span>
        <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">File</span> <span style="color: #f8f8f2">file</span> <span style="color: #f92672">:</span> <span style="color: #f8f8f2">localDir</span><span style="color: #f92672">.</span><span style="color: #a6e22e">listFiles</span><span style="color: #f92672">())</span>
            <span style="color: #f8f8f2">file</span><span style="color: #f92672">.</span><span style="color: #a6e22e">delete</span><span style="color: #f92672">();</span>
        <span style="color: #f8f8f2">localDir</span><span style="color: #f92672">.</span><span style="color: #a6e22e">delete</span><span style="color: #f92672">();</span>
    <span style="color: #f92672">}</span>
    <span style="color: #f8f8f2">localDir</span><span style="color: #f92672">.</span><span style="color: #a6e22e">mkdir</span><span style="color: #f92672">();</span>
    <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">pointsPerFile</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">)</span>
        <span style="color: #66d9ef">throw</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">IOException</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;No point to write.&quot;</span><span style="color: #f92672">);</span>
    <span style="color: #66d9ef">double</span> <span style="color: #f8f8f2">point</span><span style="color: #f92672">;</span>
    <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">hasRemainder</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span>
    <span style="color: #f8f8f2">Random</span> <span style="color: #f8f8f2">random</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">Random</span><span style="color: #f92672">();</span>
    <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">k</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">k</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">numMapTasks</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">++)</span> <span style="color: #f92672">{</span>
        <span style="color: #66d9ef">try</span> <span style="color: #f92672">{</span>
            <span style="color: #f8f8f2">String</span> <span style="color: #f8f8f2">filename</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Integer</span><span style="color: #f92672">.</span><span style="color: #a6e22e">toString</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">k</span><span style="color: #f92672">);</span>
            <span style="color: #f8f8f2">File</span> <span style="color: #f8f8f2">file</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">File</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">localDirStr</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">File</span><span style="color: #f92672">.</span><span style="color: #a6e22e">separator</span> <span style="color: #f92672">+</span> <span style="color: #e6db74">&quot;data_&quot;</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">filename</span><span style="color: #f92672">);</span>
            <span style="color: #f8f8f2">FileWriter</span> <span style="color: #f8f8f2">fw</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">FileWriter</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">file</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getAbsoluteFile</span><span style="color: #f92672">());</span>
            <span style="color: #f8f8f2">BufferedWriter</span> <span style="color: #f8f8f2">bw</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">BufferedWriter</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">fw</span><span style="color: #f92672">);</span>
            <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">pointsRemainder</span> <span style="color: #f92672">&gt;</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
                <span style="color: #f8f8f2">hasRemainder</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">1</span><span style="color: #f92672">;</span>
                <span style="color: #f8f8f2">pointsRemainder</span><span style="color: #f92672">--;</span>
            <span style="color: #f92672">}</span>
            <span style="color: #66d9ef">else</span>
                <span style="color: #f8f8f2">hasRemainder</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span>
            <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">pointsForThisFile</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">pointsPerFile</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">hasRemainder</span><span style="color: #f92672">;</span>
            <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">pointsForThisFile</span><span style="color: #f92672">;</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">++)</span>
                <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">j</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span> <span style="color: #f8f8f2">j</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">;</span> <span style="color: #f8f8f2">j</span><span style="color: #f92672">++)</span> <span style="color: #f92672">{</span>
                    <span style="color: #f8f8f2">point</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">random</span><span style="color: #f92672">.</span><span style="color: #a6e22e">nextDouble</span><span style="color: #f92672">()</span> <span style="color: #f92672">*</span> <span style="color: #f8f8f2">DATA_RANGE</span><span style="color: #f92672">;</span>
                    <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">j</span> <span style="color: #f92672">==</span> <span style="color: #f8f8f2">vectorSize</span> <span style="color: #f92672">-</span> <span style="color: #ae81ff">1</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
                        <span style="color: #f8f8f2">bw</span><span style="color: #f92672">.</span><span style="color: #a6e22e">write</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">point</span> <span style="color: #f92672">+</span> <span style="color: #e6db74">&quot;&quot;</span><span style="color: #f92672">);</span>
                        <span style="color: #f8f8f2">bw</span><span style="color: #f92672">.</span><span style="color: #a6e22e">newLine</span><span style="color: #f92672">();</span>
                    <span style="color: #f92672">}</span>
                    <span style="color: #66d9ef">else</span>
                        <span style="color: #f8f8f2">bw</span><span style="color: #f92672">.</span><span style="color: #a6e22e">write</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">point</span> <span style="color: #f92672">+</span> <span style="color: #e6db74">&quot; &quot;</span><span style="color: #f92672">);</span>
                <span style="color: #f92672">}</span>
            <span style="color: #f8f8f2">bw</span><span style="color: #f92672">.</span><span style="color: #a6e22e">close</span><span style="color: #f92672">();</span>
        <span style="color: #f92672">}</span>
        <span style="color: #66d9ef">catch</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">FileNotFoundException</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">)</span>
            <span style="color: #f8f8f2">e</span><span style="color: #f92672">.</span><span style="color: #a6e22e">printStackTrace</span><span style="color: #f92672">();</span>
        <span style="color: #66d9ef">catch</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">IOException</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">)</span>
            <span style="color: #f8f8f2">e</span><span style="color: #f92672">.</span><span style="color: #a6e22e">printStackTrace</span><span style="color: #f92672">();</span>
    <span style="color: #f92672">}</span>
    <span style="color: #f8f8f2">Path</span> <span style="color: #f8f8f2">localPath</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">Path</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">localDirStr</span><span style="color: #f92672">);</span>
    <span style="color: #f8f8f2">fs</span><span style="color: #f92672">.</span><span style="color: #a6e22e">copyFromLocalFile</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">localPath</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">dataDir</span><span style="color: #f92672">);</span>
<span style="color: #f92672">}</span>
</pre></div>

<h2 id="step-2-generate-initial-centroids">Step 2 &mdash; Generate initial centroids</h2>

<p>K-Means needs a set of initial centroids. The <code>generateInitialCentroids</code> method in <code>Utils.java</code> will generate a set of random centroids. You can generate one file contains centroids and use <code>fs</code> to write it to <code>cDir</code>. <code>JobID</code> indicates the current job. It is optional.</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">generateInitialCentroids</span><span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">numCentroids</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">Configuration</span> <span style="color: #f8f8f2">configuration</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">Path</span> <span style="color: #f8f8f2">cDir</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">FileSystem</span> <span style="color: #f8f8f2">fs</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">JobID</span><span style="color: #f92672">)</span> <span style="color: #66d9ef">throws</span> <span style="color: #f8f8f2">IOException</span> <span style="color: #f92672">{</span>
    <span style="color: #f8f8f2">Random</span> <span style="color: #f8f8f2">random</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">Random</span><span style="color: #f92672">();</span>
    <span style="color: #66d9ef">double</span><span style="color: #f92672">[]</span> <span style="color: #f8f8f2">data</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">null</span><span style="color: #f92672">;</span>
    <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">.</span><span style="color: #a6e22e">exists</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">cDir</span><span style="color: #f92672">))</span>
        <span style="color: #f8f8f2">fs</span><span style="color: #f92672">.</span><span style="color: #a6e22e">delete</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">cDir</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">true</span><span style="color: #f92672">);</span>
    <span style="color: #66d9ef">if</span> <span style="color: #f92672">(!</span><span style="color: #f8f8f2">fs</span><span style="color: #f92672">.</span><span style="color: #a6e22e">mkdirs</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">cDir</span><span style="color: #f92672">))</span>
        <span style="color: #66d9ef">throw</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">IOException</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">cDir</span><span style="color: #f92672">.</span><span style="color: #a6e22e">toString</span><span style="color: #f92672">()</span> <span style="color: #f92672">+</span> <span style="color: #e6db74">&quot;fails to be created.&quot;</span><span style="color: #f92672">);</span>
    <span style="color: #f8f8f2">data</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #66d9ef">double</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">numCentroids</span> <span style="color: #f92672">*</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">];</span>
    <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">i</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">data</span><span style="color: #f92672">.</span><span style="color: #a6e22e">length</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">++)</span>
        <span style="color: #f8f8f2">data</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">]</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">random</span><span style="color: #f92672">.</span><span style="color: #a6e22e">nextDouble</span><span style="color: #f92672">()</span> <span style="color: #f92672">*</span> <span style="color: #f8f8f2">DATA_RANGE</span><span style="color: #f92672">;</span>
    <span style="color: #f8f8f2">Path</span> <span style="color: #f8f8f2">initClustersFile</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">Path</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">cDir</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">KMeansConstants</span><span style="color: #f92672">.</span><span style="color: #a6e22e">CENTROID_FILE_NAME</span><span style="color: #f92672">);</span>
    <span style="color: #f8f8f2">FSDataOutputStream</span> <span style="color: #f8f8f2">out</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">fs</span><span style="color: #f92672">.</span><span style="color: #a6e22e">create</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">initClustersFile</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">true</span><span style="color: #f92672">);</span>
    <span style="color: #f8f8f2">BufferedWriter</span> <span style="color: #f8f8f2">bw</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">BufferedWriter</span><span style="color: #f92672">(</span><span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">OutputStreamWriter</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">out</span><span style="color: #f92672">));</span>
    <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">i</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">data</span><span style="color: #f92672">.</span><span style="color: #a6e22e">length</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">++)</span>
        <span style="color: #66d9ef">if</span> <span style="color: #f92672">((</span><span style="color: #f8f8f2">i</span> <span style="color: #f92672">%</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">)</span> <span style="color: #f92672">==</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">vectorSize</span> <span style="color: #f92672">-</span> <span style="color: #ae81ff">1</span><span style="color: #f92672">))</span> <span style="color: #f92672">{</span>
            <span style="color: #f8f8f2">bw</span><span style="color: #f92672">.</span><span style="color: #a6e22e">write</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">data</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">]</span> <span style="color: #f92672">+</span> <span style="color: #e6db74">&quot;&quot;</span><span style="color: #f92672">);</span>
            <span style="color: #f8f8f2">bw</span><span style="color: #f92672">.</span><span style="color: #a6e22e">newLine</span><span style="color: #f92672">();</span>
        <span style="color: #f92672">}</span>
        <span style="color: #66d9ef">else</span>
            <span style="color: #f8f8f2">bw</span><span style="color: #f92672">.</span><span style="color: #a6e22e">write</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">data</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">]</span> <span style="color: #f92672">+</span> <span style="color: #e6db74">&quot; &quot;</span><span style="color: #f92672">);</span>
    <span style="color: #f8f8f2">bw</span><span style="color: #f92672">.</span><span style="color: #a6e22e">flush</span><span style="color: #f92672">();</span>
    <span style="color: #f8f8f2">bw</span><span style="color: #f92672">.</span><span style="color: #a6e22e">close</span><span style="color: #f92672">();</span>
<span style="color: #f92672">}</span>
</pre></div>

<h2 id="step-3-mapper-collective">Step 3 &mdash; Mapper Collective</h2>

<p>After the completion of initialization steps, the main class will run a set of map reduce jobs iteratively. The number of iterations are specified by the user. The following code block at each iteration configure a job and run it. When configuring a job, you can use <code>MultiFileInputFormat</code> class in <code>edu.iu.fileformat</code> to set <code>inputFormatClass</code>. In this way, every map task will load data file paths. Then you can read data from the file paths in map task.</p>

<p>Each job needs to do these tasks:</p>

<ul>
<li>Read data from point files.</li>
</ul>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">static</span> <span style="color: #f8f8f2">ArrayList</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;</span> <span style="color: #a6e22e">loadData</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">List</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">String</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">fileNames</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">Configuration</span> <span style="color: #f8f8f2">conf</span><span style="color: #f92672">)</span> <span style="color: #66d9ef">throws</span> <span style="color: #f8f8f2">IOException</span> <span style="color: #f92672">{</span>
    <span style="color: #f8f8f2">ArrayList</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">data</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">ArrayList</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;();</span>
    <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">String</span> <span style="color: #f8f8f2">filename</span> <span style="color: #f92672">:</span> <span style="color: #f8f8f2">fileNames</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
        <span style="color: #f8f8f2">FileSystem</span> <span style="color: #f8f8f2">fs</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">FileSystem</span><span style="color: #f92672">.</span><span style="color: #a6e22e">get</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">conf</span><span style="color: #f92672">);</span>
        <span style="color: #f8f8f2">Path</span> <span style="color: #f8f8f2">dPath</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">Path</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">filename</span><span style="color: #f92672">);</span>
        <span style="color: #f8f8f2">FSDataInputStream</span> <span style="color: #f8f8f2">in</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">fs</span><span style="color: #f92672">.</span><span style="color: #a6e22e">open</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">dPath</span><span style="color: #f92672">);</span>
        <span style="color: #f8f8f2">BufferedReader</span> <span style="color: #f8f8f2">br</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">BufferedReader</span><span style="color: #f92672">(</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">InputStreamReader</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">in</span><span style="color: #f92672">));</span>
        <span style="color: #f8f8f2">String</span> <span style="color: #f8f8f2">line</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;&quot;</span><span style="color: #f92672">;</span>
        <span style="color: #f8f8f2">String</span><span style="color: #f92672">[]</span> <span style="color: #f8f8f2">vector</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">null</span><span style="color: #f92672">;</span>
        <span style="color: #66d9ef">while</span> <span style="color: #f92672">((</span><span style="color: #f8f8f2">line</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">br</span><span style="color: #f92672">.</span><span style="color: #a6e22e">readLine</span><span style="color: #f92672">())</span> <span style="color: #f92672">!=</span> <span style="color: #66d9ef">null</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
            <span style="color: #f8f8f2">vector</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">line</span><span style="color: #f92672">.</span><span style="color: #a6e22e">split</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;\\s+&quot;</span><span style="color: #f92672">);</span>
            <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">vector</span><span style="color: #f92672">.</span><span style="color: #a6e22e">length</span> <span style="color: #f92672">!=</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">)</span>
                <span style="color: #f8f8f2">System</span><span style="color: #f92672">.</span><span style="color: #a6e22e">exit</span><span style="color: #f92672">(-</span><span style="color: #ae81ff">1</span><span style="color: #f92672">);</span>
            <span style="color: #66d9ef">else</span> <span style="color: #f92672">{</span>
                <span style="color: #66d9ef">double</span><span style="color: #f92672">[]</span> <span style="color: #f8f8f2">aDataPoint</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #66d9ef">double</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">];</span>
                <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">i</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">++)</span>
                    <span style="color: #f8f8f2">aDataPoint</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">]</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Double</span><span style="color: #f92672">.</span><span style="color: #a6e22e">parseDouble</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">vector</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">]);</span>
                <span style="color: #f8f8f2">DoubleArray</span> <span style="color: #f8f8f2">da</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">aDataPoint</span><span style="color: #f92672">,</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">);</span>
                <span style="color: #f8f8f2">data</span><span style="color: #f92672">.</span><span style="color: #a6e22e">add</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">da</span><span style="color: #f92672">);</span>
            <span style="color: #f92672">}</span>
        <span style="color: #f92672">}</span>
    <span style="color: #f92672">}</span>
    <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">data</span><span style="color: #f92672">;</span>
<span style="color: #f92672">}</span>
</pre></div>

<ul>
<li>load centroids</li>
</ul>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">static</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">loadCentroids</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">Table</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">cenTable</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">String</span> <span style="color: #f8f8f2">cFileName</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">Configuration</span> <span style="color: #f8f8f2">configuration</span><span style="color: #f92672">)</span> <span style="color: #66d9ef">throws</span> <span style="color: #f8f8f2">IOException</span> <span style="color: #f92672">{</span>
    <span style="color: #f8f8f2">Path</span> <span style="color: #f8f8f2">cPath</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">Path</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">cFileName</span><span style="color: #f92672">);</span>
    <span style="color: #f8f8f2">FileSystem</span> <span style="color: #f8f8f2">fs</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">FileSystem</span><span style="color: #f92672">.</span><span style="color: #a6e22e">get</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">configuration</span><span style="color: #f92672">);</span>
    <span style="color: #f8f8f2">FSDataInputStream</span> <span style="color: #f8f8f2">in</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">fs</span><span style="color: #f92672">.</span><span style="color: #a6e22e">open</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">cPath</span><span style="color: #f92672">);</span>
    <span style="color: #f8f8f2">BufferedReader</span> <span style="color: #f8f8f2">br</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">BufferedReader</span><span style="color: #f92672">(</span><span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">InputStreamReader</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">in</span><span style="color: #f92672">));</span>
    <span style="color: #f8f8f2">String</span> <span style="color: #f8f8f2">line</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;&quot;</span><span style="color: #f92672">;</span>
    <span style="color: #f8f8f2">String</span><span style="color: #f92672">[]</span> <span style="color: #f8f8f2">vector</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">null</span><span style="color: #f92672">;</span>
    <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">partitionId</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span>
    <span style="color: #66d9ef">while</span> <span style="color: #f92672">((</span><span style="color: #f8f8f2">line</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">br</span><span style="color: #f92672">.</span><span style="color: #a6e22e">readLine</span><span style="color: #f92672">())</span> <span style="color: #f92672">!=</span> <span style="color: #66d9ef">null</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
        <span style="color: #f8f8f2">vector</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">line</span><span style="color: #f92672">.</span><span style="color: #a6e22e">split</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;\\s+&quot;</span><span style="color: #f92672">);</span>
        <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">vector</span><span style="color: #f92672">.</span><span style="color: #a6e22e">length</span> <span style="color: #f92672">!=</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">)</span>
            <span style="color: #f8f8f2">System</span><span style="color: #f92672">.</span><span style="color: #a6e22e">exit</span><span style="color: #f92672">(-</span><span style="color: #ae81ff">1</span><span style="color: #f92672">);</span>
        <span style="color: #66d9ef">else</span> <span style="color: #f92672">{</span>
            <span style="color: #66d9ef">double</span><span style="color: #f92672">[]</span> <span style="color: #f8f8f2">aCen</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #66d9ef">double</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">vectorSize</span> <span style="color: #f92672">+</span> <span style="color: #ae81ff">1</span><span style="color: #f92672">];</span>
            <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">i</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">++)</span>
                <span style="color: #f8f8f2">aCen</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">]</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Double</span><span style="color: #f92672">.</span><span style="color: #a6e22e">parseDouble</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">vector</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">]);</span>
            <span style="color: #f8f8f2">aCen</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">]</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span>
            <span style="color: #f8f8f2">Partition</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">ap</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">Partition</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;(</span><span style="color: #f8f8f2">partitionId</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">aCen</span><span style="color: #f92672">,</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">vectorSize</span> <span style="color: #f92672">+</span> <span style="color: #ae81ff">1</span><span style="color: #f92672">));</span>
            <span style="color: #f8f8f2">cenTable</span><span style="color: #f92672">.</span><span style="color: #a6e22e">addPartition</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">ap</span><span style="color: #f92672">);</span>
            <span style="color: #f8f8f2">partitionId</span><span style="color: #f92672">++;</span>
        <span style="color: #f92672">}</span>
    <span style="color: #f92672">}</span>
<span style="color: #f92672">}</span>
</pre></div>

<ul>
<li>broadcast centroids</li>
</ul>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">private</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">bcastCentroids</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">Table</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">table</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">bcastID</span><span style="color: #f92672">)</span> <span style="color: #66d9ef">throws</span> <span style="color: #f8f8f2">IOException</span> <span style="color: #f92672">{</span>
    <span style="color: #66d9ef">boolean</span> <span style="color: #f8f8f2">isSuccess</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">false</span><span style="color: #f92672">;</span>
    <span style="color: #66d9ef">try</span>
        <span style="color: #f8f8f2">isSuccess</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">this</span><span style="color: #f92672">.</span><span style="color: #a6e22e">broadcast</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;main&quot;</span><span style="color: #f92672">,</span> <span style="color: #e6db74">&quot;broadcast-centroids&quot;</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">table</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">bcastID</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">false</span><span style="color: #f92672">);</span>
    <span style="color: #66d9ef">catch</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">Exception</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">)</span>
        <span style="color: #f8f8f2">e</span><span style="color: #f92672">.</span><span style="color: #a6e22e">printStackTrace</span><span style="color: #f92672">();</span>
    <span style="color: #66d9ef">if</span> <span style="color: #f92672">(!</span><span style="color: #f8f8f2">isSuccess</span><span style="color: #f92672">)</span>
        <span style="color: #66d9ef">throw</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">IOException</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;Fail to bcast&quot;</span><span style="color: #f92672">);</span>
<span style="color: #f92672">}</span>
</pre></div>

<ul>
<li>find the nearest centroid <code>Cj</code> for all data points <code>V</code></li>
</ul>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">private</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">findNearestCenter</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">Table</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">cenTable</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">Table</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">previousCenTable</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">ArrayList</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">dataPoints</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
      <span style="color: #66d9ef">double</span> <span style="color: #f8f8f2">err</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span>
    <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">DoubleArray</span> <span style="color: #f8f8f2">aPoint</span> <span style="color: #f92672">:</span> <span style="color: #f8f8f2">dataPoints</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
        <span style="color: #75715e">//for each data point, find the nearest centroid</span>
        <span style="color: #66d9ef">double</span> <span style="color: #f8f8f2">minDist</span> <span style="color: #f92672">=</span> <span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f92672">;</span>
        <span style="color: #66d9ef">double</span> <span style="color: #f8f8f2">tempDist</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span>
        <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">nearestPartitionID</span> <span style="color: #f92672">=</span> <span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f92672">;</span>
        <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">Partition</span> <span style="color: #f8f8f2">ap</span> <span style="color: #f92672">:</span> <span style="color: #f8f8f2">previousCenTable</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getPartitions</span><span style="color: #f92672">())</span> <span style="color: #f92672">{</span>
            <span style="color: #f8f8f2">DoubleArray</span> <span style="color: #f8f8f2">aCentroid</span> <span style="color: #f92672">=</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">)</span><span style="color: #f8f8f2">ap</span><span style="color: #f92672">.</span><span style="color: #a6e22e">get</span><span style="color: #f92672">();</span>
            <span style="color: #66d9ef">double</span> <span style="color: #f8f8f2">dist</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span>
            <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">;</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">++)</span>
                <span style="color: #f8f8f2">dist</span> <span style="color: #f92672">+=</span> <span style="color: #f8f8f2">Math</span><span style="color: #f92672">.</span><span style="color: #a6e22e">pow</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">aPoint</span><span style="color: #f92672">.</span><span style="color: #a6e22e">get</span><span style="color: #f92672">()[</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">]</span> <span style="color: #f92672">-</span> <span style="color: #f8f8f2">aCentroid</span><span style="color: #f92672">.</span><span style="color: #a6e22e">get</span><span style="color: #f92672">()[</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">],</span> <span style="color: #ae81ff">2</span><span style="color: #f92672">);</span>
            <span style="color: #f8f8f2">tempDist</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Math</span><span style="color: #f92672">.</span><span style="color: #a6e22e">sqrt</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">dist</span><span style="color: #f92672">);</span>
            <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">minDist</span> <span style="color: #f92672">==</span> <span style="color: #f92672">-</span><span style="color: #ae81ff">1</span> <span style="color: #f92672">||</span> <span style="color: #f8f8f2">tempDist</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">minDist</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
                <span style="color: #f8f8f2">minDist</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">tempDist</span><span style="color: #f92672">;</span>
                <span style="color: #f8f8f2">nearestPartitionID</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">ap</span><span style="color: #f92672">.</span><span style="color: #a6e22e">id</span><span style="color: #f92672">();</span>
            <span style="color: #f92672">}</span>
        <span style="color: #f92672">}</span>
        <span style="color: #f8f8f2">err</span> <span style="color: #f92672">+=</span> <span style="color: #f8f8f2">minDist</span><span style="color: #f92672">;</span>
        <span style="color: #75715e">//for the certain data point, found the nearest centroid.</span>
        <span style="color: #75715e">// add the data to a new cenTable.</span>
        <span style="color: #66d9ef">double</span><span style="color: #f92672">[]</span> <span style="color: #f8f8f2">partial</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #66d9ef">double</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">vectorSize</span> <span style="color: #f92672">+</span> <span style="color: #ae81ff">1</span><span style="color: #f92672">];</span>
        <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">j</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">j</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">j</span><span style="color: #f92672">++)</span>
            <span style="color: #f8f8f2">partial</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">j</span><span style="color: #f92672">]</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">aPoint</span><span style="color: #f92672">.</span><span style="color: #a6e22e">get</span><span style="color: #f92672">()[</span><span style="color: #f8f8f2">j</span><span style="color: #f92672">];</span>
        <span style="color: #f8f8f2">partial</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">]</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">1</span><span style="color: #f92672">;</span>
        <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">cenTable</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getPartition</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">nearestPartitionID</span><span style="color: #f92672">)</span> <span style="color: #f92672">==</span> <span style="color: #66d9ef">null</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
            <span style="color: #f8f8f2">Partition</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">tmpAp</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">Partition</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;(</span><span style="color: #f8f8f2">nearestPartitionID</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">partial</span><span style="color: #f92672">,</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">vectorSize</span> <span style="color: #f92672">+</span> <span style="color: #ae81ff">1</span><span style="color: #f92672">));</span>
            <span style="color: #f8f8f2">cenTable</span><span style="color: #f92672">.</span><span style="color: #a6e22e">addPartition</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">tmpAp</span><span style="color: #f92672">);</span>
        <span style="color: #f92672">}</span>
        <span style="color: #66d9ef">else</span> <span style="color: #f92672">{</span>
            <span style="color: #f8f8f2">Partition</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">apInCenTable</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cenTable</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getPartition</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">nearestPartitionID</span><span style="color: #f92672">);</span>
            <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">i</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">vectorSize</span> <span style="color: #f92672">+</span> <span style="color: #ae81ff">1</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">++)</span>
                <span style="color: #f8f8f2">apInCenTable</span><span style="color: #f92672">.</span><span style="color: #a6e22e">get</span><span style="color: #f92672">().</span><span style="color: #a6e22e">get</span><span style="color: #f92672">()[</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">]</span> <span style="color: #f92672">+=</span> <span style="color: #f8f8f2">partial</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">];</span>
        <span style="color: #f92672">}</span>
    <span style="color: #f92672">}</span>
<span style="color: #f92672">}</span>
</pre></div>

<ul>
<li>allreduce centroids</li>
<li>update centroids</li>
</ul>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">private</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">updateCenters</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">Table</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">cenTable</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
    <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">Partition</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">partialCenTable</span> <span style="color: #f92672">:</span> <span style="color: #f8f8f2">cenTable</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getPartitions</span><span style="color: #f92672">())</span> <span style="color: #f92672">{</span>
        <span style="color: #66d9ef">double</span><span style="color: #f92672">[]</span> <span style="color: #f8f8f2">doubles</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">partialCenTable</span><span style="color: #f92672">.</span><span style="color: #a6e22e">get</span><span style="color: #f92672">().</span><span style="color: #a6e22e">get</span><span style="color: #f92672">();</span>
        <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">h</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">h</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">h</span><span style="color: #f92672">++)</span>
            <span style="color: #f8f8f2">doubles</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">h</span><span style="color: #f92672">]</span> <span style="color: #f92672">/=</span> <span style="color: #f8f8f2">doubles</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">];</span>
        <span style="color: #f8f8f2">doubles</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">]</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span>
    <span style="color: #f92672">}</span>
<span style="color: #f92672">}</span>
</pre></div>

<ul>
<li>repeat step 4 to 6</li>
<li>write centroids to HDFS</li>
</ul>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">private</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">outputResults</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">Table</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">dataTable</span><span style="color: #f92672">,</span><span style="color: #f8f8f2">Configuration</span> <span style="color: #f8f8f2">conf</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">Context</span> <span style="color: #f8f8f2">context</span><span style="color: #f92672">)</span> <span style="color: #f92672">{</span>
    <span style="color: #f8f8f2">String</span> <span style="color: #f8f8f2">output</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;&quot;</span><span style="color: #f92672">;</span>
    <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">Partition</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">ap</span> <span style="color: #f92672">:</span> <span style="color: #f8f8f2">dataTable</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getPartitions</span><span style="color: #f92672">())</span> <span style="color: #f92672">{</span>
        <span style="color: #66d9ef">double</span> <span style="color: #f8f8f2">res</span><span style="color: #f92672">[]</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">ap</span><span style="color: #f92672">.</span><span style="color: #a6e22e">get</span><span style="color: #f92672">().</span><span style="color: #a6e22e">get</span><span style="color: #f92672">();</span>
        <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">i</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">++)</span>
            <span style="color: #f8f8f2">output</span> <span style="color: #f92672">+=</span> <span style="color: #f8f8f2">res</span><span style="color: #f92672">[</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">]</span> <span style="color: #f92672">+</span> <span style="color: #e6db74">&quot;\t&quot;</span><span style="color: #f92672">;</span>
        <span style="color: #f8f8f2">output</span> <span style="color: #f92672">+=</span> <span style="color: #e6db74">&quot;\n&quot;</span><span style="color: #f92672">;</span>
    <span style="color: #f92672">}</span>
    <span style="color: #66d9ef">try</span>
        <span style="color: #f8f8f2">context</span><span style="color: #f92672">.</span><span style="color: #a6e22e">write</span><span style="color: #f92672">(</span><span style="color: #66d9ef">null</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">Text</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">output</span><span style="color: #f92672">));</span>
    <span style="color: #66d9ef">catch</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">IOException</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">)</span>
        <span style="color: #f8f8f2">e</span><span style="color: #f92672">.</span><span style="color: #a6e22e">printStackTrace</span><span style="color: #f92672">();</span>
    <span style="color: #66d9ef">catch</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">InterruptedException</span> <span style="color: #f8f8f2">e</span><span style="color: #f92672">)</span>
        <span style="color: #f8f8f2">e</span><span style="color: #f92672">.</span><span style="color: #a6e22e">printStackTrace</span><span style="color: #f92672">();</span>
<span style="color: #f92672">}</span>
</pre></div>

<p>For the java implementation, a setup method will be called to initialize the mapper class. In the setup method, all the needed configurations will be loaded. The main map task is handled in the mapCollective function. In the mapCollective function, it first gets data files from <code>KeyValReader</code> and then reads data from files. It then loads initialization centroids from HDFS. For each data point, it calculates distances between the current data point and each centroid to determine the closest centroid to the data point.</p>

<p>The structure of the iterative mapper procedure is like following:</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">protected</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">mapCollective</span><span style="color: #f92672">(</span> <span style="color: #f8f8f2">KeyValReader</span> <span style="color: #f8f8f2">reader</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">Context</span> <span style="color: #f8f8f2">context</span><span style="color: #f92672">)</span> <span style="color: #66d9ef">throws</span> <span style="color: #f8f8f2">IOException</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">InterruptedException</span> <span style="color: #f92672">{</span>
    <span style="color: #75715e">/*</span>
<span style="color: #75715e">     * vals in the keyval pairs from reader are data file paths.</span>
<span style="color: #75715e">     * read data from file paths.</span>
<span style="color: #75715e">     * load initial centroids</span>
<span style="color: #75715e">     * do{</span>
<span style="color: #75715e">     *     computations</span>
<span style="color: #75715e">     *  generate new centroids</span>
<span style="color: #75715e">     * }while(&lt;maxIteration)</span>
<span style="color: #75715e">     * </span>
<span style="color: #75715e">     */</span>
    <span style="color: #f8f8f2">List</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">String</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">pointFiles</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">ArrayList</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">String</span><span style="color: #f92672">&gt;();</span>
    <span style="color: #66d9ef">while</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">reader</span><span style="color: #f92672">.</span><span style="color: #a6e22e">nextKeyValue</span><span style="color: #f92672">())</span> <span style="color: #f92672">{</span>
        <span style="color: #f8f8f2">String</span> <span style="color: #f8f8f2">key</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">reader</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getCurrentKey</span><span style="color: #f92672">();</span>
        <span style="color: #f8f8f2">String</span> <span style="color: #f8f8f2">value</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">reader</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getCurrentValue</span><span style="color: #f92672">();</span>
        <span style="color: #f8f8f2">pointFiles</span><span style="color: #f92672">.</span><span style="color: #a6e22e">add</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">value</span><span style="color: #f92672">);</span>
    <span style="color: #f92672">}</span>
    <span style="color: #f8f8f2">Configuration</span> <span style="color: #f8f8f2">conf</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">context</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getConfiguration</span><span style="color: #f92672">();</span>
    <span style="color: #f8f8f2">runKmeans</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">pointFiles</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">conf</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">context</span><span style="color: #f92672">);</span>
<span style="color: #f92672">}</span>

<span style="color: #66d9ef">private</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">runKmeans</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">List</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">String</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">fileNames</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">Configuration</span> <span style="color: #f8f8f2">conf</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">Context</span> <span style="color: #f8f8f2">context</span><span style="color: #f92672">)</span> <span style="color: #66d9ef">throws</span> <span style="color: #f8f8f2">IOException</span> <span style="color: #f92672">{</span>
    <span style="color: #f8f8f2">ArrayList</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">dataPoints</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Utils</span><span style="color: #f92672">.</span><span style="color: #a6e22e">loadData</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">fileNames</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">conf</span><span style="color: #f92672">);</span>
    <span style="color: #f8f8f2">Table</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">cenTable</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">Table</span><span style="color: #f92672">&lt;&gt;(</span><span style="color: #ae81ff">0</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">DoubleArrPlus</span><span style="color: #f92672">());</span>
    <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">this</span><span style="color: #f92672">.</span><span style="color: #a6e22e">isMaster</span><span style="color: #f92672">())</span>
        <span style="color: #f8f8f2">Utils</span><span style="color: #f92672">.</span><span style="color: #a6e22e">loadCentroids</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">cenTable</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">vectorSize</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">cFile</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">conf</span><span style="color: #f92672">);</span>
    <span style="color: #f8f8f2">bcastCentroids</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">cenTable</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">this</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getMasterID</span><span style="color: #f92672">());</span>
    <span style="color: #f8f8f2">Table</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">&gt;</span> <span style="color: #f8f8f2">previousCenTable</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">null</span><span style="color: #f92672">;</span>
    <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">iter</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">iter</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">iteration</span><span style="color: #f92672">;</span><span style="color: #f8f8f2">iter</span><span style="color: #f92672">++)</span> <span style="color: #f92672">{</span>
        <span style="color: #f8f8f2">previousCenTable</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cenTable</span><span style="color: #f92672">;</span>
        <span style="color: #f8f8f2">cenTable</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">Table</span><span style="color: #f92672">&lt;&gt;(</span><span style="color: #ae81ff">0</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">DoubleArrPlus</span><span style="color: #f92672">());</span>
        <span style="color: #f8f8f2">findNearestCenter</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">cenTable</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">previousCenTable</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">dataPoints</span><span style="color: #f92672">);</span>
        <span style="color: #f8f8f2">allreduce</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;main&quot;</span><span style="color: #f92672">,</span> <span style="color: #e6db74">&quot;allreduce_&quot;</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">iter</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">cenTable</span><span style="color: #f92672">);</span>
        <span style="color: #f8f8f2">updateCenters</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">cenTable</span><span style="color: #f92672">);</span>
    <span style="color: #f92672">}</span>
    <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">this</span><span style="color: #f92672">.</span><span style="color: #a6e22e">isMaster</span><span style="color: #f92672">())</span>
        <span style="color: #f8f8f2">outputResults</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">cenTable</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">conf</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">context</span><span style="color: #f92672">);</span>
    <span style="color: #f92672">}</span>
<span style="color: #f92672">}</span>
</pre></div>
</article></section></div></div></div><script src="https://code.jquery.com/jquery-2.2.1.min.js"></script><script src="https://dsc-spidal.github.io/harp/js/app.min.js"></script></body></html>