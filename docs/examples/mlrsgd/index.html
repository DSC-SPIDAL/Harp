<!DOCTYPE html><html lang="en-us"><head><link rel="shortcut icon" type="image/png" sizes="16x16" href="https://dsc-spidal.github.io/harp/img/favicon-16x9.png"><link rel="shortcut icon" type="image/png" sizes="32x32" href="https://dsc-spidal.github.io/harp/img/favicon-32x18.png"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Hugo 0.18" /><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="harp"><meta property="og:image" content="/img/logo54x54.png"><meta property="og:url" content="https://dsc-spidal.github.io/harp/"><meta name="twitter:title" content="harp"><meta name="twitter:image" content="/img/0-1-1.png"><meta property="og:site_name" content="Harp Multiclass Logistic Regression with Stochastic Gradient Descent"><meta property="og:url" content="/docs/examples/mlrsgd/"><meta property="og:description" content=""><meta name="twitter:description" content=""><title>harp Documentation - Harp Multiclass Logistic Regression with Stochastic Gradient Descent</title><link rel="stylesheet" href="https://dsc-spidal.github.io/harp/css/style.min.css"><link rel="stylesheet" href="https://dsc-spidal.github.io/harp/css/font-awesome.min.css"><link rel="stylesheet" href="https://dsc-spidal.github.io/harp/css/pygments.css"></head><body><nav class="hn-top-navbar navbar navbar-inverse navbar-fixed-top" role="navigation"><div class="hn-navbar-container container-fluid"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#hn-navbar" aria-controls="hn-navbar" aria-expanded="false"><span class="sr-only"><Toggle>navigation</Toggle></span><i class="hn-toggle-button fa fa-bars"></i></button><a class="hn-navbar-logo navbar-brand" href="https://dsc-spidal.github.io/harp/"><img class="pull-left" src="https://dsc-spidal.github.io/harp/img/0-1-2.png" width="76%"></a></div><div id="hn-navbar" class="navbar-collapse collapse"><ul class="nav navbar-nav navbar-right"><li><a href="https://dsc-spidal.github.io/harp/docs/getting-started">Documentation</a></li><li><a href="https://dsc-spidal.github.io/harp/api">API</a></li></ul></div></div></nav><div class="hn-main"><div class="container"><div class="row"><aside class="hn-sidebar hidden-xs col-sm-4 col-md-3 col-lg-2 collapse"><nav class="hn-sidebar-nav"><div id="hn-accordion-1" class="panel-group" role="tablist" aria-multiselectable="true"><div class="panel panel-default"><section id="installation-guide" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion-1" href="#collapse-installation-guide" aria-labelledby="installation-guide"><i class="fa fa-caret-right"></i>Installation Guide</a></h4></section><div id="collapse-installation-guide" class="panel-collapse collapse" aria-labelledby="installation-guide"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/prerequisites">Prerequisites</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/getting-started">Harp Installation (Single Node)</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/getting-started-cluster">Harp Installation (Cluster)</a></li></ul></div></div></div></div></nav><nav class="hn-sidebar-nav"><div id="hn-accordion-2" class="panel-group" role="tablist" aria-multiselectable="true"><div class="panel panel-default"><section id="beginners-guide" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion-2" href="#collapse-beginners-guide" aria-labelledby="beginners-guide"><i class="fa fa-caret-right"></i>Beginners Guide</a></h4></section><div id="collapse-beginners-guide" class="panel-collapse collapse" aria-labelledby="beginners-guide"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/beginnersguide/mlr">Multiclass Logistic Regression</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/beginnersguide/svm">Support Vector Machine</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/beginnersguide/svm">Support Vector Machine</a></li></ul></div></div></div></div></nav><h2 class="panel-title"><b>Users Guide</b></h2><br><nav class="hn-sidebar-nav"><div id="hn-accordion-2" class="panel-group" role="tablist" aria-multiselectable="true"><div class="panel panel-default"><section id="applications" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion-2" href="#collapse-applications" aria-labelledby="applications"><i class="fa fa-caret-right"></i>Applications</a></h4></section><div id="collapse-applications" class="panel-collapse collapse" aria-labelledby="applications"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/applications/lda-cgs">Latent Dirichlet Allocation (CGS)</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/applications/mf">Matrix Factorization</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/applications/sahad">Subgraph Counting</a></li></ul></div></div></div></div></nav><h2 class="panel-title"><b>Contributors Guide</b></h2><br><nav class="hn-sidebar-nav"><div id="hn-accordion-3" class="panel-group" role="tablist" aria-multiselectable="true"><div class="panel panel-default"><section id="programming-guides" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion-3" href="#collapse-programming-guides" aria-labelledby="programming-guides"><i class="fa fa-caret-right"></i>Programming Guides</a></h4></section><div id="collapse-programming-guides" class="panel-collapse collapse" aria-labelledby="programming-guides"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/programming/overview">Overview</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/programming/data-interface">Data Interfaces and Types</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/programming/scheduler">Schedulers</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/programming/computation-models">Computation Models</a></li></ul></div></div></div><div class="panel panel-default"><section id="collective-communication" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion-3" href="#collapse-collective-communication" aria-labelledby="collective-communication"><i class="fa fa-caret-right"></i>Collective Communication</a></h4></section><div id="collapse-collective-communication" class="panel-collapse collapse" aria-labelledby="collective-communication"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/communications/broadcast">Broadcast</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/reduce">Reduce</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/allgather">Allgather</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/allreduce">Allreduce</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/regroup">Regroup</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/pushandpull">Push &amp; Pull</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/rotate">Rotate</a></li></ul></div></div></div><div class="panel panel-default"><section id="examples" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion-3" href="#collapse-examples" aria-labelledby="examples"><i class="fa fa-caret-right"></i>Examples</a></h4></section><div id="collapse-examples" class="panel-collapse collapse" aria-labelledby="examples"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/examples/overview">Overview</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/kmeans">K-Means</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/mlrsgd">Multiclass Logistic Regression</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/lda">Latent Dirichlet Allocation (CVB)</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/svm">Support Vector Machine</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/rf">Random Forests</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/nn">Neural Network</a></li></ul></div></div></div></div></nav><h2 class="panel-title"><b>Harp-DAAL Documentation</b></h2><br><nav class="hn-sidebar-nav"><div id="hn-accordion-4" class="panel-group" role="tablist" aria-multiselectable="true"><div class="panel panel-default"><section id="overview" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion-4" href="#collapse-overview" aria-labelledby="overview"><i class="fa fa-caret-right"></i>Overview</a></h4></section><div id="collapse-overview" class="panel-collapse collapse" aria-labelledby="overview"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/harpdaal">Harp-DAAL framework</a></li></ul></div></div></div><div class="panel panel-default"><section id="harp-daal-api" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion-4" href="#collapse-harp-daal-api" aria-labelledby="harp-daal-api"><i class="fa fa-caret-right"></i>Harp-DAAL API</a></h4></section><div id="collapse-harp-daal-api" class="panel-collapse collapse" aria-labelledby="harp-daal-api"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/harpdaalInit">Initialization Module</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/harpdaalIO">I/O Module</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/harpdaalComm">Communication Module</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/BatchModeEg">Batch Mode Code Walk Through</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/DistriModeEg">Distributed Mode Code Walk Through</a></li></ul></div></div></div><div class="panel panel-default"><section id="algorithm" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion-4" href="#collapse-algorithm" aria-labelledby="algorithm"><i class="fa fa-caret-right"></i>Algorithm</a></h4></section><div id="collapse-algorithm" class="panel-collapse collapse" aria-labelledby="algorithm"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#arpos">Association Rule</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#covpos">Covariance</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#boostpos">Boosting</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#naivepos">Naive Bayes Classifier</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#kmeanspos">K-Means Clustering</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#empos">Expectation-Maximization</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#pcapos">Principal Component Analysis</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#svdpos">Singular Value Decomposition</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#qrpos">QR Decomposition</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#pqrpos">Pivoted-QR Decomposition</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#ckdpos">Cholesky Decomposition</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#mompos">Low Order Moments</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#odpos">Outlier Detection</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#sortpos">Sorting</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#qtepos">Quantile</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#qmpos">Quality Metrics</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#optpos">Optimization Solvers</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#normpos">Normalization</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#svmpos">Support Vector Machine</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#knnpos">K-Nearest Neighbors Classifier</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#dtreepos">Decision Tree</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#dforestpos">Decision Forest</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#kernelfuncpos">Kernel Functions</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#stumppos">Stump Weak Learner Classifier</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#linregpos">Linear Regression</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#reregpos">Ridge Regression</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#alspos">Implicit Alternating Least Squares</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/algorithms#nnpos">Neural Network</a></li></ul></div></div></div><div class="panel panel-default"><section id="application" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion-4" href="#collapse-application" aria-labelledby="application"><i class="fa fa-caret-right"></i>Application</a></h4></section><div id="collapse-application" class="panel-collapse collapse" aria-labelledby="application"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/MF-SGD">Recommender System based on SGD</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/Subgraph">Subgraph Counting</a></li></ul></div></div></div><div class="panel panel-default"><section id="hands-on" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion-4" href="#collapse-hands-on" aria-labelledby="hands-on"><i class="fa fa-caret-right"></i>Hands-on</a></h4></section><div id="collapse-hands-on" class="panel-collapse collapse" aria-labelledby="hands-on"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/handson">Tutorial</a></li></ul></div></div></div></div></nav></aside><section class="hn-docs-main col-sm-8 col-md-9 col-lg-10 col-sm-offset-4 col-md-offset-3 col-lg-offset-2"><header class="hn-docs-header page-header"><h1>Harp Multiclass Logistic Regression with Stochastic Gradient Descent</h1><div class="hn-docs-description"></div></header><article class="hn-docs-content">

<p>Before going through this tutorial take a look at the <a href="https://dsc-spidal.github.io/harp/docs/examples/overview/">overview</a> section to get an understanding of the structure of the tutorial.</p>

<p><img src="https://dsc-spidal.github.io/harp/img/4-3-1.png" width="60%"  ></p>

<p>Definitions:</p>

<ul>
<li><code>N</code> is the number of data points</li>
<li><code>T</code> is the number of labels</li>
<li><code>M</code> is the number of features</li>
<li><code>W</code> is the <code>T*M</code> weight matrix</li>
<li><code>K</code> is the number of iteration</li>
</ul>

<p><code>Multiclass logistic regression (MLR)</code> is a classification method that generalizes logistic regression to multiclass problems, i.e. with more than two possible discrete outcomes. It is a model that is used to predict the probabilities of the different possible outcomes of a categorically distributed dependent variable, given a set of independent variables.</p>

<p>The process of the MLR algorithm is:</p>

<ol>
<li><p>Use the weight <code>W</code> to predict the label of current data point.</p></li>

<li><p>Compare the output and the answer.</p></li>

<li><p>Use SGD to approximate <code>W</code>.</p></li>

<li><p>Repeat step 1 to 3 with each label and their weights.</p></li>
</ol>

<p><code>Stochastic gradient descent (SGD)</code> is a stochastic approximation of the gradient descent optimization method for minimizing an objective function that is written as the sum of differentiable functions. In other words, SGD tries to find minimums or maximums by iteration. As the algorithm sweeps through the training set, it performs the update for each training example. Several passes can be made over the training set until the algorithm converges.</p>

<p>The SGD algorithm can be described as following:</p>

<ol>
<li><p>Randomly assign the weight <code>W</code>.</p></li>

<li><p>Shuffle <code>N</code> data points.</p></li>

<li><p>Go through <code>N</code> data points and do gradient descent.</p></li>

<li><p>Repeat step 2 and 3 <code>K</code> times.</p></li>
</ol>

<h2 id="parallel-design">PARALLEL DESIGN</h2>

<ul>
<li><p>What are the models? What kind of data structure is applicable?</p>

<p>The weight vectors for classes are models. Because an ovr(one-versus-rest) approach is adopted, each weight vector is independent. It has a matrix structure.</p></li>

<li><p>What are the characteristics of the data dependency in model update computation? Can updates run concurrently?</p>

<p>Model update computation here is the SGD update, in which for each data point it should update the model directly. Because of the ovr strategy, each row in the model matrix is independent, and can be updated in parallel.</p></li>

<li><p>Which kind of parallelism scheme is suitable, data parallelism or model parallelism?</p>

<p>Data parallelism can be used, i.e., calculating different data points in parallel.</p>

<p>Because the updates can run concurrently, model parallelism is a nature solution.  Each node gets one partition of the model, which updates in parallel. And furthermore, thread level parallelism can also follow this model parallelism pattern, that each thread takes a subset of partition and updates in parallel independently.</p></li>

<li><p>Which collective communication operation is suitable to synchronize the model?</p>

<p>DynamicScheduler can be used for thread-level parallelism, and Rotate can be used in the inter-node model synchronization.</p></li>
</ul>

<h2 id="dataflow">DATAFLOW</h2>

<p><img src="https://dsc-spidal.github.io/harp/img/4-3-2.png" alt="dataflow" /></p>

<h2 id="step-0-data-preprocessing">Step 0 &mdash; Data preprocessing</h2>

<p>Harp MLR will use the data in the vector format. Each vector in a file is represented by the format <code>&lt;did&gt; [&lt;fid&gt;:&lt;weight&gt;]</code>:</p>

<ul>
<li><code>&lt;did&gt;</code> is an unique document id</li>
<li><code>&lt;fid&gt;</code> is a positive feature id</li>
<li><code>&lt;weight&gt;</code> is the number feature value within document weight</li>
</ul>

<p>After preprocessing, push the data set into HDFS by the following commands.</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>hdfs dfs -mkdir /input
hdfs dfs -put input_data/* /input
</pre></div>

<h2 id="step-1-initialize">Step 1 &mdash; Initialize</h2>

<p>For Harp MLR, we will use dynamic scheduling as mentioned above. Before we set up the dynamic scheduler, we need to initialize the weight matrix <code>W</code>, which will be partitioned into <code>T</code> parts representing to <code>T</code> labels which means that each label belongs to one partition and is treated as an independent task.</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">private</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">initTable</span><span style="color: #f92672">()</span> <span style="color: #f92672">{</span>
    <span style="color: #f8f8f2">wTable</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">Table</span><span style="color: #f92672">(</span><span style="color: #ae81ff">0</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">DoubleArrPlus</span><span style="color: #f92672">());</span>
    <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">topics</span><span style="color: #f92672">.</span><span style="color: #a6e22e">size</span><span style="color: #f92672">();</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">++)</span>
        <span style="color: #f8f8f2">wTable</span><span style="color: #f92672">.</span><span style="color: #a6e22e">addPartition</span><span style="color: #f92672">(</span><span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">Partition</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">i</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">DoubleArray</span><span style="color: #f92672">.</span><span style="color: #a6e22e">create</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">TERM</span> <span style="color: #f92672">+</span> <span style="color: #ae81ff">1</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">false</span><span style="color: #f92672">)));</span>
<span style="color: #f92672">}</span>
</pre></div>

<p>After that, we can initialize the dynamic scheduler. Each thread will be treated as a worker and will be added into the scheduler. The only thing that needs to be done is that tasks have to be submitted during the computation.</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">private</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">initThread</span><span style="color: #f92672">()</span> <span style="color: #f92672">{</span>
    <span style="color: #f8f8f2">GDthread</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">LinkedList</span><span style="color: #f92672">&lt;&gt;();</span>
    <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">numThread</span><span style="color: #f92672">;</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">++)</span>
        <span style="color: #f8f8f2">GDthread</span><span style="color: #f92672">.</span><span style="color: #a6e22e">add</span><span style="color: #f92672">(</span><span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">GDtask</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">alpha</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">data</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">topics</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">qrels</span><span style="color: #f92672">));</span>
    <span style="color: #f8f8f2">GDsch</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">DynamicScheduler</span><span style="color: #f92672">&lt;&gt;(</span><span style="color: #f8f8f2">GDthread</span><span style="color: #f92672">);</span>
<span style="color: #f92672">}</span>
</pre></div>

<h2 id="step-2-mapper-communication">Step 2 &mdash; Mapper communication</h2>

<p>In this main process, we use <code>regroup</code> to distribute the partitions to the workers first. The workers will get almost the same number of partitions. Then we start the scheduler. Each time we submit one partition to each thread in the scheduler, the threads will all use SGD to approximate <code>W</code> with each label. After the workers finish once with their own partitions, we will use <code>rotate</code> operation to swap the partitions among the workers. After all the processes finish, each worker should use its own data training the whole partition <code>K</code> times, where <code>K</code> is the number of iterations. <code>allgather</code> operation collects all partitions in each worker, combines the partitions, and shares the outcome with all workers. Finally, the Master worker outputs the weight matrix <code>W</code>.</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">protected</span> <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">mapCollective</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">KeyValReader</span> <span style="color: #f8f8f2">reader</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">Context</span> <span style="color: #f8f8f2">context</span><span style="color: #f92672">)</span> <span style="color: #66d9ef">throws</span> <span style="color: #f8f8f2">IOException</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">InterruptedException</span> <span style="color: #f92672">{</span>
    <span style="color: #f8f8f2">LoadAll</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">reader</span><span style="color: #f92672">);</span>
    <span style="color: #f8f8f2">initTable</span><span style="color: #f92672">();</span>
    <span style="color: #f8f8f2">initThread</span><span style="color: #f92672">();</span>

    <span style="color: #f8f8f2">regroup</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;MLR&quot;</span><span style="color: #f92672">,</span> <span style="color: #e6db74">&quot;regroup_wTable&quot;</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">wTable</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">Partitioner</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">getNumWorkers</span><span style="color: #f92672">()));</span>

    <span style="color: #f8f8f2">GDsch</span><span style="color: #f92672">.</span><span style="color: #a6e22e">start</span><span style="color: #f92672">();</span>        
    <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">iter</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f92672">;</span> <span style="color: #f8f8f2">iter</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">ITER</span> <span style="color: #f92672">*</span> <span style="color: #f8f8f2">numMapTask</span><span style="color: #f92672">;</span> <span style="color: #f8f8f2">iter</span><span style="color: #f92672">++)</span> <span style="color: #f92672">{</span>
        <span style="color: #66d9ef">for</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">Partition</span> <span style="color: #f8f8f2">par</span> <span style="color: #f92672">:</span> <span style="color: #f8f8f2">wTable</span><span style="color: #f92672">.</span><span style="color: #a6e22e">getPartitions</span><span style="color: #f92672">())</span>
            <span style="color: #f8f8f2">GDsch</span><span style="color: #f92672">.</span><span style="color: #a6e22e">submit</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">par</span><span style="color: #f92672">);</span>
        <span style="color: #66d9ef">while</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">GDsch</span><span style="color: #f92672">.</span><span style="color: #a6e22e">hasOutput</span><span style="color: #f92672">())</span>
            <span style="color: #f8f8f2">GDsch</span><span style="color: #f92672">.</span><span style="color: #a6e22e">waitForOutput</span><span style="color: #f92672">();</span>
            
        <span style="color: #f8f8f2">rotate</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;MLR&quot;</span><span style="color: #f92672">,</span> <span style="color: #e6db74">&quot;rotate_&quot;</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">iter</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">wTable</span><span style="color: #f92672">,</span> <span style="color: #66d9ef">null</span><span style="color: #f92672">);</span>

        <span style="color: #f8f8f2">context</span><span style="color: #f92672">.</span><span style="color: #a6e22e">progress</span><span style="color: #f92672">();</span>
    <span style="color: #f92672">}</span>
    <span style="color: #f8f8f2">GDsch</span><span style="color: #f92672">.</span><span style="color: #a6e22e">stop</span><span style="color: #f92672">();</span>
        
    <span style="color: #f8f8f2">allgather</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;MLR&quot;</span><span style="color: #f92672">,</span> <span style="color: #e6db74">&quot;allgather_wTable&quot;</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">wTable</span><span style="color: #f92672">);</span>

    <span style="color: #66d9ef">if</span> <span style="color: #f92672">(</span><span style="color: #f8f8f2">isMaster</span><span style="color: #f92672">())</span>
        <span style="color: #f8f8f2">Util</span><span style="color: #f92672">.</span><span style="color: #a6e22e">outputData</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">outputPath</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">topics</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">wTable</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">conf</span><span style="color: #f92672">);</span>
    <span style="color: #f8f8f2">wTable</span><span style="color: #f92672">.</span><span style="color: #a6e22e">release</span><span style="color: #f92672">();</span>
<span style="color: #f92672">}</span>
</pre></div>

<h1 id="data">Data</h1>

<p>The dataset used is the (RCV1-v2)[<a href="http://www.ai.mit.edu/projects/jmlr/papers/volume5/lewis04a/lyrl2004_rcv1v2_README.htm">http://www.ai.mit.edu/projects/jmlr/papers/volume5/lewis04a/lyrl2004_rcv1v2_README.htm</a>] dataset.</p>

<h1 id="run-example">Run example</h1>

<h3 id="compile">Compile</h3>

<p>Select the profile related to your hadoop version. For ex: hadoop-2.6.0. Supported hadoop versions are 2.6.0, 2.7.5
and 2.9.0</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">cd</span> <span style="color: #f8f8f2">$HARP_ROOT_DIR</span>
mvn clean package -Phadoop-2.6.0
</pre></div>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">cd</span> <span style="color: #f8f8f2">$HARP_ROOT_DIR</span>/contrib/target
cp contrib-0.1.0.jar <span style="color: #f8f8f2">$HADOOP_HOME</span>
<span style="color: #f8f8f2">cd</span> <span style="color: #f8f8f2">$HADOOP_HOME</span>
</pre></div>

<h3 id="put-data-on-hdfs">Put data on hdfs</h3>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>hdfs dfs -mkdir /rcv1v2
rm -rf data
mkdir -p data
<span style="color: #f8f8f2">cd</span> data
split -l <span style="color: #ae81ff">1000</span> <span style="color: #f8f8f2">$HARP_ROOT_DIR</span>/datasets/tutorial/rcv1/lyrl2004_vectors_train.dat
<span style="color: #f8f8f2">cd</span> ..
hdfs dfs -put data /rcv1v2
hdfs dfs -put <span style="color: #f8f8f2">$HARP_ROOT_DIR</span>/datasets/tutorial/rcv1/rcv1* /rcv1v2
</pre></div>

<h3 id="run">Run</h3>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>hadoop jar contrib-0.1.0.jar edu.iu.mlr.MLRMapCollective <span style="color: #f92672">[</span>alpha<span style="color: #f92672">]</span> <span style="color: #f92672">[</span>number of iteration<span style="color: #f92672">]</span> <span style="color: #f92672">[</span>number of features<span style="color: #f92672">]</span> <span style="color: #f92672">[</span>number of workers<span style="color: #f92672">]</span> <span style="color: #f92672">[</span>number of threads<span style="color: #f92672">]</span> <span style="color: #f92672">[</span>topic file path<span style="color: #f92672">]</span> <span style="color: #f92672">[</span>qrel file path<span style="color: #f92672">]</span> <span style="color: #f92672">[</span>input path in HDFS<span style="color: #f92672">]</span> <span style="color: #f92672">[</span>output path in HDFS<span style="color: #f92672">]</span>
</pre></div>

<h3 id="example">Example</h3>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>hadoop jar contrib-0.1.0.jar edu.iu.mlr.MLRMapCollective 1.0 <span style="color: #ae81ff">100</span> <span style="color: #ae81ff">47236</span> <span style="color: #ae81ff">2</span> <span style="color: #ae81ff">4</span> /rcv1v2/rcv1.topics.txt /rcv1v2/rcv1-v2.topics.qrels /rcv1v2 /output
</pre></div>

<p>The output should be the weight matrix <code>W</code>.
Please refer to the test scripts (mlr.sh) under test_scripts for more details.</p>
</article></section></div></div></div><script src="https://code.jquery.com/jquery-2.2.1.min.js"></script><script src="https://dsc-spidal.github.io/harp/js/app.min.js"></script></body></html>