<!DOCTYPE html><html lang="en-us"><head><link rel="shortcut icon" type="image/png" sizes="16x16" href="https://dsc-spidal.github.io/harp/img/favicon-16x9.png"><link rel="shortcut icon" type="image/png" sizes="32x32" href="https://dsc-spidal.github.io/harp/img/favicon-32x18.png"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Hugo 0.18" /><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="harp"><meta property="og:image" content="/img/logo54x54.png"><meta property="og:url" content="https://dsc-spidal.github.io/harp/"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@heronstreaming"><meta name="twitter:title" content="harp"><meta name="twitter:image" content="/img/0-1-1.png"><meta property="og:site_name" content="Topology Troubleshooting Guide"><meta property="og:url" content="/docs/developers/troubleshooting/"><meta property="og:description" content=""><meta name="twitter:description" content=""><title>harp Documentation - Topology Troubleshooting Guide</title><link rel="stylesheet" href="https://dsc-spidal.github.io/harp/css/style.min.css"><link rel="stylesheet" href="https://dsc-spidal.github.io/harp/css/font-awesome.min.css"><link rel="stylesheet" href="https://dsc-spidal.github.io/harp/css/pygments.css"></head><body><nav class="hn-top-navbar navbar navbar-inverse navbar-fixed-top" role="navigation"><div class="hn-navbar-container container-fluid"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#hn-navbar" aria-controls="hn-navbar" aria-expanded="false"><span class="sr-only"><Toggle>navigation</Toggle></span><i class="hn-toggle-button fa fa-bars"></i></button><a class="hn-navbar-logo navbar-brand" href="https://dsc-spidal.github.io/harp/"><img class="pull-left" src="https://dsc-spidal.github.io/harp/img/0-1-2.png"></a></div><div id="hn-navbar" class="navbar-collapse collapse"><ul class="nav navbar-nav navbar-right"><li><a href="https://dsc-spidal.github.io/harp/docs/getting-started">Docs</a></li><li><a href="https://dsc-spidal.github.io/harp/api">API</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/resources">Resources</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/contributors/community">Community</a></li><li><a href="https://dsc-spidal.github.io/harp/">GitHub</a></li><li><a href="https://groups.google.com/forum/#!forum/harp-users">Mailing List</a></li></ul></div></div></nav><div class="hn-main"><div class="container"><div class="row"><aside class="hn-sidebar hidden-xs col-sm-4 col-md-3 col-lg-2 collapse"><nav class="hn-sidebar-nav"><div id="hn-accordion" class="panel-group" role="tablist" aria-multiselectable="true"><div class="panel panel-default"><section id="getting-started" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-getting-started" aria-labelledby="getting-started"><i class="fa fa-caret-right"></i>Getting Started</a></h4></section><div id="collapse-getting-started" class="panel-collapse collapse" aria-labelledby="getting-started"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/getting-started">Harp Installation</a></li></ul></div></div></div><div class="panel panel-default"><section id="harp-concepts" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-harp-concepts" aria-labelledby="harp-concepts"><i class="fa fa-caret-right"></i>Harp Concepts</a></h4></section><div id="collapse-harp-concepts" class="panel-collapse collapse" aria-labelledby="harp-concepts"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/concepts/features">Features</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/concepts/computation-models">Computation Models</a></li></ul></div></div></div><div class="panel panel-default"><section id="data-interfaces-and-types" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-data-interfaces-and-types" aria-labelledby="data-interfaces-and-types"><i class="fa fa-caret-right"></i>Data Interfaces and Types</a></h4></section><div id="collapse-data-interfaces-and-types" class="panel-collapse collapse" aria-labelledby="data-interfaces-and-types"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/data-interface">Data Interfaces and Types</a></li></ul></div></div></div><div class="panel panel-default"><section id="collective-communication" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-collective-communication" aria-labelledby="collective-communication"><i class="fa fa-caret-right"></i>Collective Communication</a></h4></section><div id="collapse-collective-communication" class="panel-collapse collapse" aria-labelledby="collective-communication"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/communications/broadcast">broadcast</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/reduce">reduce</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/allgather">allgather</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/allreduce">allreduce</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/regroup">regroup</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/pushandpull">push &amp; pull</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/communications/rotate">rotate</a></li></ul></div></div></div><div class="panel panel-default"><section id="schedulers" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-schedulers" aria-labelledby="schedulers"><i class="fa fa-caret-right"></i>Schedulers</a></h4></section><div id="collapse-schedulers" class="panel-collapse collapse" aria-labelledby="schedulers"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/scheduler/static-scheduler">Static Scheduler</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/scheduler/dynamic-scheduler">Dynamic Scheduler</a></li></ul></div></div></div><div class="panel panel-default"><section id="examples" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-examples" aria-labelledby="examples"><i class="fa fa-caret-right"></i>Examples</a></h4></section><div id="collapse-examples" class="panel-collapse collapse" aria-labelledby="examples"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/examples/kmeans">k-means</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/allreducekmeans">allreduce k-means</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/bcastreducekmeans">broadcast &amp; reduce k-means</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/pushpullkmeans">push &amp; pull k-means</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/regroupallgatherkmeans">regroup &amp; allgather k-means</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/latentdirichletallocation">latent dirichlet allocation</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/mlrsgd">Multiclass Logistic Regression</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/lda">LDA</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/examples/svm">SVM</a></li></ul></div></div></div><div class="panel panel-default"><section id="harp-daal" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-harp-daal" aria-labelledby="harp-daal"><i class="fa fa-caret-right"></i>Harp-DAAL</a></h4></section><div id="collapse-harp-daal" class="panel-collapse collapse" aria-labelledby="harp-daal"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/harpdaal">Harp-DAAL</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/harpdaal/Example">Example</a></li></ul></div></div></div><div class="panel panel-default"><section id="harp-resources" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-harp-resources" aria-labelledby="harp-resources"><i class="fa fa-caret-right"></i>Harp Resources</a></h4></section><div id="collapse-harp-resources" class="panel-collapse collapse" aria-labelledby="harp-resources"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/resources">Harp Resources</a></li></ul></div></div></div><div class="panel panel-default"><section id="contributors" class="panel-heading" role="tab"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#hn-accordion" href="#collapse-contributors" aria-labelledby="contributors"><i class="fa fa-caret-right"></i>Contributors</a></h4></section><div id="collapse-contributors" class="panel-collapse collapse" aria-labelledby="contributors"><div class="panel-body"><ul><li><a href="https://dsc-spidal.github.io/harp/docs/contributors/community">Community</a></li><li><a href="https://dsc-spidal.github.io/harp/docs/contributors/contributors">Contributors</a></li></ul></div></div></div></div></nav></aside><section class="hn-docs-main col-sm-8 col-md-9 col-lg-10 col-sm-offset-4 col-md-offset-3 col-lg-offset-2"><header class="hn-docs-header page-header"><h1>Topology Troubleshooting Guide</h1><div class="hn-docs-description"></div></header><article class="hn-docs-content">

<h3 id="overview">Overview</h3>

<p>This guide provides basic steps to troubleshoot a topology.
These are starting steps to troubleshoot potential issues and identify root causes easily.</p>

<p>This guide is organized into following broad sections:</p>

<ul>
<li><a href="#running">Determine topology running status and health</a></li>
<li><a href="#problem">Identify topology problems</a></li>
<li><a href="#frequent">Frequently seen issues</a></li>
</ul>

<p>This guide is useful for topology developers. Issues related to Heron <a href="../../../docs/operators/configuration/config-intro">configuration setup</a> or
its <a href="../../../docs/concepts/architecture">internal architecture</a>, like <code>schedulers</code>, etc, are discussed in Configuration and Heron Developers respectively, and not discussed here.</p>

<p><a name="running"></a></p>

<h3 id="determine-topology-running-status-and-health">Determine topology running status and health</h3>

<h4 id="1-estimate-your-data-rate">1. Estimate your data rate</h4>

<p>It is important to estimate how much data a topology is expected to consume.
A useful approach is to begin by estimating a data rate in terms of items per minute. The emit count (tuples per minute) of each spout should match the data rate for the corresponding data
stream. If spouts are not consuming and emitting the data at the same rate as it
is produced, this is called <code>spout lag</code>.</p>

<p>Some spouts, like <code>Kafka Spout</code> have a lag metric that can be
directly used to measure health. It is recommended to have some kind of lag
metric for a custom spout, so that it&rsquo;s easier to check and create monitoring alerts.</p>

<h4 id="2-absent-backpressure">2. Absent Backpressure</h4>

<p>Backpressure initiated by an instance means that the concerned instance is not
able to consume data at the same rate at which it is being receiving. This
results in all spouts getting clamped (they will not consume any more data)
until the backpressure is relieved by the instance.</p>

<p>Backpressure is measured in milliseconds per minute, the time an instance was under backpressure.  For example, a value of 60,000 means an instance was under backpressure for the whole minute (60 seconds).</p>

<p>A healthy topology should not have backpressure. Backpressure usually results in the
spout lag build up since spouts get clamped, but it should not be considered as
a cause, only a symptom.</p>

<p>Therefore, adjust and iterate Topology until backpressure is absent.</p>

<h4 id="3-absent-failures">3. Absent failures</h4>

<p>Failed tuples are generally considered bad for a topology, unless it is a required feature (for instance, lowest possible latency is needed at the expense of possible dropped tuples). If
<code>acking</code> is disabled, or even when enabled and not handled properly in spouts,
this can result in data loss, without adding spout lag.</p>

<p><a name="problem"></a></p>

<h3 id="identify-topology-problems">Identify topology problems</h3>

<h4 id="1-look-at-instances-under-backpressure">1. Look at instances under backpressure</h4>

<p>Backpressure metrics identifies which instances have been under backpressure. Therefore, jump directly to the logs of that instance to see what is going wrong with the
instance. Some of the known causes of backpressure are discussed in the <a href="#frequent">frequently seen issues</a> section below.</p>

<h4 id="2-look-at-items-pending-to-be-acked">2. Look at items pending to be acked</h4>

<p>Spouts export a metric which is a sampled value of the number of tuples
still in flight in the topology. Sometimes, <code>max-spout-pending</code> config limits
the consumption rate of the topology. Increasing that spout&rsquo;s parallelism
generally solves the issue.</p>

<p><a name="frequent"></a></p>

<h3 id="frequently-seen-issues">Frequently seen issues</h3>

<h4 id="1-topology-does-not-launch">1. Topology does not launch</h4>

<p><em>Symptom</em> - Heron client fails to launch the topology.</p>

<p>Note that heron client will execute the topology&rsquo;s <code>main</code> method on the local
system, which means spouts and bolts get instantiated locally, serialized, and then
sent over to schedulers as part of <code>topology.defn</code>. It is important to make sure
that:</p>

<ol>
<li>All spouts and bolts are serializable.</li>
<li>Don&rsquo;t instantiate a non-serializable attribute in constructor. Leave those to
a bolt&rsquo;s <code>prepare</code> or a spout&rsquo;s <code>open</code> method, which gets called during start
time of the instances.</li>
<li>The <code>main</code> method should not try to access anything that your local machine
may not have access to.</li>
</ol>

<h4 id="2-topology-does-not-start">2. Topology does not start</h4>

<p>We assume here that heron client has successfully launched the topology.</p>

<p><em>Symptom</em> - Physical plan or logical plan does not show up on UI</p>

<p><em>Possible Cause</em> - One of more of stream managers have not yet connected to
Tmaster.</p>

<p><em>What to do</em> -</p>

<ol>
<li><p>Go to the Tmaster logs for the topology. The zeroth container is reserved for
Tmaster. Go to the container and browse to</p>

<pre><code>log-files/heron-tmaster-&lt;topology-name&gt;&lt;topology-id&gt;.INFO
</code></pre>

<p>and see which stream managers have not yet connected. The <code>stmgr</code> ID
corresponds to the container number. For example, <code>stmgr-10</code> corresponds to
container 10, and so on.</p></li>

<li><p>Visit that container to
see what is wrong in stream manager&rsquo;s logs, which can be found in <code>log-files</code>
directory similar to Tmaster.</p></li>
</ol>

<h4 id="3-instances-are-not-starting-up">3. Instances are not starting up</h4>

<p>A topology would not start until all the instances are running. This may be a cause of a topology not starting.</p>

<p><em>Symptom</em> - The stream manager logs for that instance never showed that the
instance connected to it.</p>

<p><em>Possible Cause</em> - Bad configs being passed when the instance process was
getting launched.</p>

<p><em>What to do</em> -</p>

<ol>
<li><p>Visit the container and browse to <code>heron-executor.stdout</code> and
<code>heron-executor.stderr</code> files. All commands to instantiate the instances and
stream managers are redirected to these files.</p></li>

<li><p>Check jvm configs for anything amiss.</p></li>

<li><p>If <code>Xmx</code> is too low, increase <code>containerRAM</code> or <code>componentRAM</code>. Note that
because heron sets aside some RAM for its internal components, like stream
manager and metrics manager, having a large number of instances and low
<code>containerRAM</code> may starve off these instances.</p></li>
</ol>

<h4 id="4-metrics-for-a-component-are-missing-absent">4. Metrics for a component are missing/absent</h4>

<p><em>Symptom</em> - The upstream component is emitting data, but this component is not
executing any, and no metrics are being reported.</p>

<p><em>Possible Cause</em> - The component might be stuck in a deadlock. Since one
instance is a single JVM process and user code is called from the main thread,
it is possible that execution is stuck in <code>execute</code> method.</p>

<p><em>What to do</em> -</p>

<ol>
<li><p>Check logs for one of the concerned instances. If <code>open</code> (in a spout) or
<code>prepare</code> (in a bolt) method is not completed, check the code logic to see
why the method is not completed.</p></li>

<li><p>Check the code logic if there is any deadlock in a bolt&rsquo;s <code>execute</code> or a
spout&rsquo;s <code>nextTuple</code>, <code>ack</code> or <code>fail</code> methods. These methods should be
non-blocking.</p></li>
</ol>

<h4 id="5-there-is-backpressure-from-internal-bolt">5. There is backpressure from internal bolt</h4>

<p>Bolts are called internal if it does not talk to any external service. For example,
the last bolt might be talking to some database to write its results, and would
not be called an internal bolt.</p>

<p>This is invariably due to lack of resources given to this bolt. Increasing
parallelism or RAM (based on code logic) can solve the issue.</p>

<h4 id="6-there-is-backpressure-from-external-bolt">6. There is backpressure from external bolt</h4>

<p>By the same definition as above, an external bolt is the one which is accessing
an external service. It might still be emitting data downstream.</p>

<p><em>Possible Cause 1</em> - External service is slowing down this bolt.</p>

<p><em>What to do</em> -</p>

<ol>
<li><p>Check if the external service is the bottleneck, and see if adding resources
to it can solve it.</p></li>

<li><p>Sometimes, changing bolt logic to tune caching vs write rate can make a
difference.</p></li>
</ol>

<p><em>Possible Cause 2</em> - Resource crunch for this bolt, just like an internal bolt
above.</p>

<p><em>What to do</em> -</p>

<ol>
<li>This should be handled in the same was as internal bolt - by increasing the
parallelism or RAM for the component.</li>
</ol>

<h4 id="7-debugging-java-topologies">7. Debugging Java topologies.</h4>

<p>The jar containing the code for building the topology, along with the spout and bolt
code, is deployed in the containers. A Heron Instance is started in each container,
with each Heron Instance responsible for running a bolt or a spout. One way to debug
Java code is to write debug logs to the log files for tracking and debugging purposes.</p>

<p>Logging is the preferred mode for debugging as it makes it easer to find issues in both
the short and long term in the topology. If you want to perform step-by-step debugging
of a JVM process, however, this can be achieved by enabling remote debugging for the Heron Instance.</p>

<p>Follow these steps to enable remote debugging:</p>

<ol>
<li><p>Add the java options to enable debuggin on all the Heron Instances that will be started.
This can be achieved by adding the options <code>-agentlib:jdwp=transport=dt_socket,address=8888,server=y,suspend=n</code>. Here&rsquo;s an example:</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">conf</span><span style="color: #f92672">.</span><span style="color: #a6e22e">setDebug</span><span style="color: #f92672">(</span><span style="color: #66d9ef">true</span><span style="color: #f92672">);</span>
<span style="color: #f8f8f2">conf</span><span style="color: #f92672">.</span><span style="color: #a6e22e">setMaxSpoutPending</span><span style="color: #f92672">(</span><span style="color: #ae81ff">10</span><span style="color: #f92672">);</span>
<span style="color: #f8f8f2">conf</span><span style="color: #f92672">.</span><span style="color: #a6e22e">put</span><span style="color: #f92672">(</span><span style="color: #f8f8f2">Config</span><span style="color: #f92672">.</span><span style="color: #a6e22e">TOPOLOGY_WORKER_CHILDOPTS</span><span style="color: #f92672">,</span> <span style="color: #e6db74">&quot;-XX:+HeapDumpOnOutOfMemoryError&quot;</span><span style="color: #f92672">);</span>
<span style="color: #f8f8f2">conf</span><span style="color: #f92672">.</span><span style="color: #a6e22e">setComponentJvmOptions</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;word&quot;</span><span style="color: #f92672">,</span>
       <span style="color: #e6db74">&quot;-agentlib:jdwp=transport=dt_socket,address=8888,server=y,suspend=n&quot;</span><span style="color: #f92672">);</span>
<span style="color: #f8f8f2">conf</span><span style="color: #f92672">.</span><span style="color: #a6e22e">setComponentJvmOptions</span><span style="color: #f92672">(</span><span style="color: #e6db74">&quot;exclaim1&quot;</span><span style="color: #f92672">,</span>
       <span style="color: #e6db74">&quot;-agentlib:jdwp=transport=dt_socket,address=8888,server=y,suspend=n&quot;</span><span style="color: #f92672">);</span>
</pre></div></li>

<li><p>Use the steps as given in the tutorial to setup remote debugging eith eclipse.
<a href="http://help.eclipse.org/neon/index.jsp?topic=%2Forg.eclipse.jdt.doc.user%2Ftasks%2Ftask-remotejava_launch_config.htm">set up Remote Debugging in Eclipse</a> .
To setup remote debugging with intelij use <a href="https://www.jetbrains.com/help/idea/2016.2/run-debug-configuration-remote.html">remote debugging instructions</a> .</p></li>

<li><p>Once the topology is activated start the debugger at <code>localhost:{port}</code> if in standalone
local deployment or <code>{IP}/{hostname}:{port}</code> for multi container remote deployment. And you will be able to debug the code step by step.</p></li>
</ol>
</article></section></div></div></div><script src="https://code.jquery.com/jquery-2.2.1.min.js"></script><script src="https://dsc-spidal.github.io/harp/js/app.min.js"></script></body></html>